<html>
<head>
<title>scratch_1.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #bcbec4;}
.s1 { color: #cf8e6d;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
scratch_1.py</font>
</center></td></tr></table>
<pre>    <span class="s1">import </span><span class="s0">numpy </span><span class="s1">as </span><span class="s0">np</span>
    <span class="s1">import </span><span class="s0">pandas </span><span class="s1">as </span><span class="s0">pd</span>
    <span class="s1">from </span><span class="s0">datetime </span><span class="s1">import </span><span class="s0">datetime</span>
    <span class="s1">import </span><span class="s0">seaborn </span><span class="s1">as </span><span class="s0">sns</span>
    <span class="s1">import </span><span class="s0">matplotlib</span><span class="s2">.</span><span class="s0">pyplot </span><span class="s1">as </span><span class="s0">plt</span>

    <span class="s3"># Load the dataset</span>
    <span class="s3"># Adjust the path as needed.</span>
    <span class="s0">df </span><span class="s2">= </span><span class="s0">pd</span><span class="s2">.</span><span class="s0">read_excel</span><span class="s2">(</span><span class="s4">&quot;C:</span><span class="s1">\\</span><span class="s4">Users</span><span class="s1">\\</span><span class="s4">Win10</span><span class="s1">\\</span><span class="s4">Desktop</span><span class="s1">\\</span><span class="s4">ACM476 Data Mining Course</span><span class="s1">\\</span><span class="s4">OnlineRetail.xlsx&quot;</span><span class="s2">)</span>

    <span class="s3">############################################################</span>
    <span class="s3"># INITIAL DATA INSPECTION</span>
    <span class="s3">############################################################</span>
    <span class="s3"># Display first rows for a quick overview</span>
    <span class="s0">display</span><span class="s2">(</span><span class="s0">df</span><span class="s2">.</span><span class="s0">head</span><span class="s2">())</span>

    <span class="s3"># Check dataset shape and structure</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Data Shape:&quot;</span><span class="s2">, </span><span class="s0">df</span><span class="s2">.</span><span class="s0">shape</span><span class="s2">)</span>
    <span class="s0">df</span><span class="s2">.</span><span class="s0">info</span><span class="s2">()</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Column Names:&quot;</span><span class="s2">, </span><span class="s0">df</span><span class="s2">.</span><span class="s0">columns</span><span class="s2">)</span>

    <span class="s3"># Check missing values</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Missing Values:</span><span class="s1">\n</span><span class="s4">&quot;</span><span class="s2">, </span><span class="s0">df</span><span class="s2">.</span><span class="s0">isnull</span><span class="s2">().</span><span class="s0">sum</span><span class="s2">())</span>

    <span class="s3"># Descriptive stats for all columns</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Descriptive Statistics:</span><span class="s1">\n</span><span class="s4">&quot;</span><span class="s2">, </span><span class="s0">df</span><span class="s2">.</span><span class="s0">describe</span><span class="s2">(</span><span class="s0">include</span><span class="s2">=</span><span class="s4">'all'</span><span class="s2">))</span>

    <span class="s3">############################################################</span>
    <span class="s3"># HANDLING MISSING CUSTOMERID</span>
    <span class="s3">############################################################</span>
    <span class="s3"># CustomerID is critical for customer-level analysis. Remove rows without it.</span>
    <span class="s0">missing_customer_id_df </span><span class="s2">= </span><span class="s0">df</span><span class="s2">[</span><span class="s0">df</span><span class="s2">[</span><span class="s4">'CustomerID'</span><span class="s2">].</span><span class="s0">isna</span><span class="s2">()].</span><span class="s0">copy</span><span class="s2">()</span>

    <span class="s1">if not </span><span class="s0">missing_customer_id_df</span><span class="s2">.</span><span class="s0">empty</span><span class="s2">:</span>
        <span class="s0">missing_customer_id_df</span><span class="s2">.</span><span class="s0">to_csv</span><span class="s2">(</span><span class="s4">&quot;missing_customer_id_rows.csv&quot;</span><span class="s2">, </span><span class="s0">index</span><span class="s2">=</span><span class="s1">False</span><span class="s2">)</span>
        <span class="s0">print</span><span class="s2">(</span><span class="s4">f&quot;Saved </span><span class="s1">{</span><span class="s0">len</span><span class="s2">(</span><span class="s0">missing_customer_id_df</span><span class="s2">)</span><span class="s1">} </span><span class="s4">rows with missing CustomerID.&quot;</span><span class="s2">)</span>
    <span class="s1">else</span><span class="s2">:</span>
        <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;No rows with missing CustomerID found.&quot;</span><span class="s2">)</span>

    <span class="s0">df </span><span class="s2">= </span><span class="s0">df</span><span class="s2">.</span><span class="s0">dropna</span><span class="s2">(</span><span class="s0">subset</span><span class="s2">=[</span><span class="s4">'CustomerID'</span><span class="s2">])</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;After removing missing CustomerID, shape:&quot;</span><span class="s2">, </span><span class="s0">df</span><span class="s2">.</span><span class="s0">shape</span><span class="s2">)</span>

    <span class="s3">############################################################</span>
    <span class="s3"># FILLING MISSING DESCRIPTIONS</span>
    <span class="s3">############################################################</span>
    <span class="s3"># Fill missing descriptions by the mode of each StockCode group.</span>
    <span class="s0">df</span><span class="s2">[</span><span class="s4">'Description'</span><span class="s2">] = </span><span class="s0">df</span><span class="s2">.</span><span class="s0">groupby</span><span class="s2">(</span><span class="s4">'StockCode'</span><span class="s2">)[</span><span class="s4">'Description'</span><span class="s2">].</span><span class="s0">transform</span><span class="s2">(</span>
        <span class="s1">lambda </span><span class="s0">x</span><span class="s2">: </span><span class="s0">x</span><span class="s2">.</span><span class="s0">fillna</span><span class="s2">(</span><span class="s0">x</span><span class="s2">.</span><span class="s0">mode</span><span class="s2">()[</span><span class="s5">0</span><span class="s2">] </span><span class="s1">if not </span><span class="s0">x</span><span class="s2">.</span><span class="s0">mode</span><span class="s2">().</span><span class="s0">empty </span><span class="s1">else </span><span class="s4">''</span><span class="s2">)</span>
    <span class="s2">)</span>

    <span class="s3">############################################################</span>
    <span class="s3"># DEALING WITH DUPLICATES</span>
    <span class="s3">############################################################</span>
    <span class="s0">duplicates </span><span class="s2">= </span><span class="s0">df</span><span class="s2">[</span><span class="s0">df</span><span class="s2">.</span><span class="s0">duplicated</span><span class="s2">()]</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Number of duplicate rows:&quot;</span><span class="s2">, </span><span class="s0">duplicates</span><span class="s2">.</span><span class="s0">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>

    <span class="s1">if not </span><span class="s0">duplicates</span><span class="s2">.</span><span class="s0">empty</span><span class="s2">:</span>
        <span class="s0">display</span><span class="s2">(</span><span class="s0">duplicates</span><span class="s2">.</span><span class="s0">head</span><span class="s2">())  </span><span class="s3"># Show a few examples of duplicates</span>

    <span class="s0">duplicates</span><span class="s2">.</span><span class="s0">to_csv</span><span class="s2">(</span><span class="s4">&quot;duplicates.csv&quot;</span><span class="s2">, </span><span class="s0">index</span><span class="s2">=</span><span class="s1">False</span><span class="s2">)</span>
    <span class="s0">df </span><span class="s2">= </span><span class="s0">df</span><span class="s2">.</span><span class="s0">drop_duplicates</span><span class="s2">()</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;After removing duplicates, shape:&quot;</span><span class="s2">, </span><span class="s0">df</span><span class="s2">.</span><span class="s0">shape</span><span class="s2">)</span>

    <span class="s3">############################################################</span>
    <span class="s3"># CORRELATION &amp; MULTICOLLINEARITY CHECK</span>
    <span class="s3">############################################################</span>
    <span class="s3"># Check numerical columns for correlation to identify multicollinearity.</span>
    <span class="s0">numeric_df </span><span class="s2">= </span><span class="s0">df</span><span class="s2">.</span><span class="s0">select_dtypes</span><span class="s2">(</span><span class="s0">include</span><span class="s2">=[</span><span class="s0">np</span><span class="s2">.</span><span class="s0">number</span><span class="s2">])</span>
    <span class="s0">cor_matrix </span><span class="s2">= </span><span class="s0">numeric_df</span><span class="s2">.</span><span class="s0">corr</span><span class="s2">().</span><span class="s0">abs</span><span class="s2">()</span>

    <span class="s0">plt</span><span class="s2">.</span><span class="s0">figure</span><span class="s2">(</span><span class="s0">figsize</span><span class="s2">=(</span><span class="s5">12</span><span class="s2">, </span><span class="s5">10</span><span class="s2">))</span>
    <span class="s0">sns</span><span class="s2">.</span><span class="s0">heatmap</span><span class="s2">(</span><span class="s0">cor_matrix</span><span class="s2">, </span><span class="s0">cmap</span><span class="s2">=</span><span class="s4">'RdBu'</span><span class="s2">, </span><span class="s0">annot</span><span class="s2">=</span><span class="s1">True</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">title</span><span class="s2">(</span><span class="s4">&quot;Correlation Matrix of Numeric Features&quot;</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">show</span><span class="s2">()</span>

    <span class="s3"># Identify columns with correlation &gt; 0.90</span>
    <span class="s0">upper_triangle_matrix </span><span class="s2">= </span><span class="s0">cor_matrix</span><span class="s2">.</span><span class="s0">where</span><span class="s2">(</span><span class="s0">np</span><span class="s2">.</span><span class="s0">triu</span><span class="s2">(</span><span class="s0">np</span><span class="s2">.</span><span class="s0">ones</span><span class="s2">(</span><span class="s0">cor_matrix</span><span class="s2">.</span><span class="s0">shape</span><span class="s2">), </span><span class="s0">k</span><span class="s2">=</span><span class="s5">1</span><span class="s2">).</span><span class="s0">astype</span><span class="s2">(</span><span class="s0">bool</span><span class="s2">))</span>
    <span class="s0">high_corr </span><span class="s2">= [</span><span class="s0">col </span><span class="s1">for </span><span class="s0">col </span><span class="s1">in </span><span class="s0">upper_triangle_matrix</span><span class="s2">.</span><span class="s0">columns </span><span class="s1">if </span><span class="s0">any</span><span class="s2">(</span><span class="s0">upper_triangle_matrix</span><span class="s2">[</span><span class="s0">col</span><span class="s2">] &gt; </span><span class="s5">0.90</span><span class="s2">)]</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Highly correlated columns (&gt;0.90):&quot;</span><span class="s2">, </span><span class="s0">high_corr</span><span class="s2">)</span>

    <span class="s3">############################################################</span>
    <span class="s3"># OUTLIER REMOVAL (IQR METHOD)</span>
    <span class="s3">############################################################</span>
    <span class="s1">def </span><span class="s0">remove_outliers</span><span class="s2">(</span><span class="s0">data</span><span class="s2">, </span><span class="s0">column</span><span class="s2">, </span><span class="s0">multiplier</span><span class="s2">=</span><span class="s5">3.0</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Remove outliers based on IQR method. 
        Multiplier controls how aggressive the removal is. 
        Higher multiplier =&gt; fewer outliers removed. 
        &quot;&quot;&quot;</span>
        <span class="s0">q1 </span><span class="s2">= </span><span class="s0">data</span><span class="s2">[</span><span class="s0">column</span><span class="s2">].</span><span class="s0">quantile</span><span class="s2">(</span><span class="s5">0.25</span><span class="s2">)</span>
        <span class="s0">q3 </span><span class="s2">= </span><span class="s0">data</span><span class="s2">[</span><span class="s0">column</span><span class="s2">].</span><span class="s0">quantile</span><span class="s2">(</span><span class="s5">0.75</span><span class="s2">)</span>
        <span class="s0">iqr </span><span class="s2">= </span><span class="s0">q3 </span><span class="s2">- </span><span class="s0">q1</span>
        <span class="s0">lower_bound </span><span class="s2">= </span><span class="s0">q1 </span><span class="s2">- </span><span class="s0">multiplier </span><span class="s2">* </span><span class="s0">iqr</span>
        <span class="s0">upper_bound </span><span class="s2">= </span><span class="s0">q3 </span><span class="s2">+ </span><span class="s0">multiplier </span><span class="s2">* </span><span class="s0">iqr</span>
        <span class="s1">return </span><span class="s0">data</span><span class="s2">[(</span><span class="s0">data</span><span class="s2">[</span><span class="s0">column</span><span class="s2">] &gt;= </span><span class="s0">lower_bound</span><span class="s2">) &amp; (</span><span class="s0">data</span><span class="s2">[</span><span class="s0">column</span><span class="s2">] &lt;= </span><span class="s0">upper_bound</span><span class="s2">)]</span>

    <span class="s0">numeric_columns </span><span class="s2">= </span><span class="s0">numeric_df</span><span class="s2">.</span><span class="s0">columns</span>

    <span class="s3"># Apply outlier removal to each numeric column.</span>
    <span class="s1">for </span><span class="s0">col </span><span class="s1">in </span><span class="s0">numeric_columns</span><span class="s2">:</span>
        <span class="s0">df </span><span class="s2">= </span><span class="s0">remove_outliers</span><span class="s2">(</span><span class="s0">df</span><span class="s2">, </span><span class="s0">col</span><span class="s2">, </span><span class="s0">multiplier</span><span class="s2">=</span><span class="s5">3.0</span><span class="s2">)</span>

    <span class="s3"># Check distributions with boxplots after outlier removal</span>
    <span class="s1">for </span><span class="s0">col </span><span class="s1">in </span><span class="s0">numeric_columns</span><span class="s2">:</span>
        <span class="s0">plt</span><span class="s2">.</span><span class="s0">figure</span><span class="s2">(</span><span class="s0">figsize</span><span class="s2">=(</span><span class="s5">8</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
        <span class="s0">sns</span><span class="s2">.</span><span class="s0">boxplot</span><span class="s2">(</span><span class="s0">x</span><span class="s2">=</span><span class="s0">df</span><span class="s2">[</span><span class="s0">col</span><span class="s2">])</span>
        <span class="s0">plt</span><span class="s2">.</span><span class="s0">title</span><span class="s2">(</span><span class="s4">f&quot;Boxplot of </span><span class="s1">{</span><span class="s0">col</span><span class="s1">} </span><span class="s4">After Outlier Removal&quot;</span><span class="s2">)</span>
        <span class="s0">plt</span><span class="s2">.</span><span class="s0">show</span><span class="s2">()</span>

    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Shape after outlier removal:&quot;</span><span class="s2">, </span><span class="s0">df</span><span class="s2">.</span><span class="s0">shape</span><span class="s2">)</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Statistics after outlier removal:</span><span class="s1">\n</span><span class="s4">&quot;</span><span class="s2">, </span><span class="s0">df</span><span class="s2">.</span><span class="s0">describe</span><span class="s2">())</span>

    <span class="s3">############################################################</span>
    <span class="s3"># EXPLORATORY STATISTICS BASED ON TARGET VARIABLES</span>
    <span class="s3">############################################################</span>
    <span class="s1">def </span><span class="s0">target_summary_with_num</span><span class="s2">(</span><span class="s0">dataframe</span><span class="s2">, </span><span class="s0">target</span><span class="s2">, </span><span class="s0">num_col</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Compute and print mean of 'num_col' grouped by 'target'. 
        Useful to understand differences in numeric features across categories. 
        &quot;&quot;&quot;</span>
        <span class="s0">summary </span><span class="s2">= </span><span class="s0">dataframe</span><span class="s2">.</span><span class="s0">groupby</span><span class="s2">(</span><span class="s0">target</span><span class="s2">)[</span><span class="s0">num_col</span><span class="s2">].</span><span class="s0">mean</span><span class="s2">()</span>
        <span class="s0">print</span><span class="s2">(</span><span class="s4">f&quot;</span><span class="s1">\n</span><span class="s4">Mean </span><span class="s1">{</span><span class="s0">num_col</span><span class="s1">} </span><span class="s4">by </span><span class="s1">{</span><span class="s0">target</span><span class="s1">}</span><span class="s4">:</span><span class="s1">\n{</span><span class="s0">summary</span><span class="s1">}\n</span><span class="s4">&quot;</span><span class="s2">)</span>
        <span class="s1">return </span><span class="s0">summary</span>

    <span class="s1">def </span><span class="s0">calculate_total_price</span><span class="s2">(</span><span class="s0">dataframe</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Ensure 'TotalPrice' = Quantity * UnitPrice is computed. 
        Also show how many transactions are above or below average spending. 
        This helps understand the distribution and skewness. 
        &quot;&quot;&quot;</span>
        <span class="s0">dataframe</span><span class="s2">[</span><span class="s4">'TotalPrice'</span><span class="s2">] = </span><span class="s0">dataframe</span><span class="s2">[</span><span class="s4">'Quantity'</span><span class="s2">] * </span><span class="s0">dataframe</span><span class="s2">[</span><span class="s4">'UnitPrice'</span><span class="s2">]</span>
        <span class="s0">mean_total_price </span><span class="s2">= </span><span class="s0">dataframe</span><span class="s2">[</span><span class="s4">'TotalPrice'</span><span class="s2">].</span><span class="s0">mean</span><span class="s2">()</span>
        <span class="s0">above_mean_count </span><span class="s2">= (</span><span class="s0">dataframe</span><span class="s2">[</span><span class="s4">'TotalPrice'</span><span class="s2">] &gt; </span><span class="s0">mean_total_price</span><span class="s2">).</span><span class="s0">sum</span><span class="s2">()</span>
        <span class="s0">below_mean_count </span><span class="s2">= (</span><span class="s0">dataframe</span><span class="s2">[</span><span class="s4">'TotalPrice'</span><span class="s2">] &lt; </span><span class="s0">mean_total_price</span><span class="s2">).</span><span class="s0">sum</span><span class="s2">()</span>
        <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Transactions above average:&quot;</span><span class="s2">, </span><span class="s0">above_mean_count</span><span class="s2">)</span>
        <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Transactions below average:&quot;</span><span class="s2">, </span><span class="s0">below_mean_count</span><span class="s2">)</span>
        <span class="s1">return </span><span class="s0">dataframe</span>

    <span class="s0">df </span><span class="s2">= </span><span class="s0">calculate_total_price</span><span class="s2">(</span><span class="s0">df</span><span class="s2">)</span>

    <span class="s3"># Analyze metrics grouped by different categories</span>
    <span class="s0">target_summary_with_num</span><span class="s2">(</span><span class="s0">df</span><span class="s2">, </span><span class="s4">'Country'</span><span class="s2">, </span><span class="s4">'Quantity'</span><span class="s2">)</span>
    <span class="s0">target_summary_with_num</span><span class="s2">(</span><span class="s0">df</span><span class="s2">, </span><span class="s4">'Country'</span><span class="s2">, </span><span class="s4">'TotalPrice'</span><span class="s2">)</span>
    <span class="s0">target_summary_with_num</span><span class="s2">(</span><span class="s0">df</span><span class="s2">, </span><span class="s4">'CustomerID'</span><span class="s2">, </span><span class="s4">'TotalPrice'</span><span class="s2">)</span>
    <span class="s0">target_summary_with_num</span><span class="s2">(</span><span class="s0">df</span><span class="s2">, </span><span class="s4">'InvoiceNo'</span><span class="s2">, </span><span class="s4">'TotalPrice'</span><span class="s2">)</span>
    <span class="s0">target_summary_with_num</span><span class="s2">(</span><span class="s0">df</span><span class="s2">, </span><span class="s4">'StockCode'</span><span class="s2">, </span><span class="s4">'Quantity'</span><span class="s2">)</span>

    <span class="s3"># Add Year column for yearly trend analysis</span>
    <span class="s0">df</span><span class="s2">[</span><span class="s4">'Year'</span><span class="s2">] = </span><span class="s0">df</span><span class="s2">[</span><span class="s4">'InvoiceDate'</span><span class="s2">].</span><span class="s0">dt</span><span class="s2">.</span><span class="s0">year</span>
    <span class="s0">target_summary_with_num</span><span class="s2">(</span><span class="s0">df</span><span class="s2">, </span><span class="s4">'Year'</span><span class="s2">, </span><span class="s4">'TotalPrice'</span><span class="s2">)</span>

    <span class="s3"># Check if TotalPrice exists and analyze negatives if any</span>
    <span class="s1">if </span><span class="s4">'TotalPrice' </span><span class="s1">not in </span><span class="s0">df</span><span class="s2">.</span><span class="s0">columns</span><span class="s2">:</span>
        <span class="s0">df</span><span class="s2">[</span><span class="s4">'TotalPrice'</span><span class="s2">] = </span><span class="s0">df</span><span class="s2">[</span><span class="s4">'Quantity'</span><span class="s2">] * </span><span class="s0">df</span><span class="s2">[</span><span class="s4">'UnitPrice'</span><span class="s2">]</span>
    <span class="s1">else</span><span class="s2">:</span>
        <span class="s0">negative_total_price_count </span><span class="s2">= (</span><span class="s0">df</span><span class="s2">[</span><span class="s4">'TotalPrice'</span><span class="s2">] &lt; </span><span class="s5">0</span><span class="s2">).</span><span class="s0">sum</span><span class="s2">()</span>
        <span class="s0">negative_quantity_count </span><span class="s2">= (</span><span class="s0">df</span><span class="s2">[</span><span class="s4">'Quantity'</span><span class="s2">] &lt; </span><span class="s5">0</span><span class="s2">).</span><span class="s0">sum</span><span class="s2">()</span>
        <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Negative TotalPrice count:&quot;</span><span class="s2">, </span><span class="s0">negative_total_price_count</span><span class="s2">)</span>
        <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Negative Quantity count:&quot;</span><span class="s2">, </span><span class="s0">negative_quantity_count</span><span class="s2">)</span>

        <span class="s3"># Separate returns and non-returns</span>
        <span class="s0">returns_df </span><span class="s2">= </span><span class="s0">df</span><span class="s2">[(</span><span class="s0">df</span><span class="s2">[</span><span class="s4">'Quantity'</span><span class="s2">] &lt; </span><span class="s5">0</span><span class="s2">) | (</span><span class="s0">df</span><span class="s2">[</span><span class="s4">'TotalPrice'</span><span class="s2">] &lt; </span><span class="s5">0</span><span class="s2">)]</span>
        <span class="s0">non_returns_df </span><span class="s2">= </span><span class="s0">df</span><span class="s2">[(</span><span class="s0">df</span><span class="s2">[</span><span class="s4">'Quantity'</span><span class="s2">] &gt;= </span><span class="s5">0</span><span class="s2">) &amp; (</span><span class="s0">df</span><span class="s2">[</span><span class="s4">'TotalPrice'</span><span class="s2">] &gt;= </span><span class="s5">0</span><span class="s2">)]</span>

        <span class="s3"># Recalculate purchased and returned quantities by customer</span>
        <span class="s0">total_quantity </span><span class="s2">= </span><span class="s0">non_returns_df</span><span class="s2">.</span><span class="s0">groupby</span><span class="s2">(</span><span class="s4">'CustomerID'</span><span class="s2">)[</span><span class="s4">'Quantity'</span><span class="s2">].</span><span class="s0">sum</span><span class="s2">()</span>
        <span class="s0">returned_quantity </span><span class="s2">= </span><span class="s0">returns_df</span><span class="s2">.</span><span class="s0">groupby</span><span class="s2">(</span><span class="s4">'CustomerID'</span><span class="s2">)[</span><span class="s4">'Quantity'</span><span class="s2">].</span><span class="s0">sum</span><span class="s2">().</span><span class="s0">abs</span><span class="s2">()</span>

        <span class="s3"># Return rate per customer</span>
        <span class="s0">return_rate </span><span class="s2">= (</span><span class="s0">returned_quantity </span><span class="s2">/ </span><span class="s0">total_quantity</span><span class="s2">).</span><span class="s0">fillna</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
        <span class="s0">return_count </span><span class="s2">= </span><span class="s0">returns_df</span><span class="s2">.</span><span class="s0">groupby</span><span class="s2">(</span><span class="s4">'CustomerID'</span><span class="s2">).</span><span class="s0">size</span><span class="s2">()</span>
        <span class="s0">total_return_amount </span><span class="s2">= </span><span class="s0">returns_df</span><span class="s2">.</span><span class="s0">groupby</span><span class="s2">(</span><span class="s4">'CustomerID'</span><span class="s2">)[</span><span class="s4">'TotalPrice'</span><span class="s2">].</span><span class="s0">sum</span><span class="s2">().</span><span class="s0">abs</span><span class="s2">()</span>

        <span class="s3"># Add return-related features</span>
        <span class="s0">df</span><span class="s2">[</span><span class="s4">'ReturnRate'</span><span class="s2">] = </span><span class="s0">df</span><span class="s2">[</span><span class="s4">'CustomerID'</span><span class="s2">].</span><span class="s0">map</span><span class="s2">(</span><span class="s0">return_rate</span><span class="s2">)</span>
        <span class="s0">df</span><span class="s2">[</span><span class="s4">'ReturnCount'</span><span class="s2">] = </span><span class="s0">df</span><span class="s2">[</span><span class="s4">'CustomerID'</span><span class="s2">].</span><span class="s0">map</span><span class="s2">(</span><span class="s0">return_count</span><span class="s2">).</span><span class="s0">fillna</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
        <span class="s0">df</span><span class="s2">[</span><span class="s4">'TotalReturnAmount'</span><span class="s2">] = </span><span class="s0">df</span><span class="s2">[</span><span class="s4">'CustomerID'</span><span class="s2">].</span><span class="s0">map</span><span class="s2">(</span><span class="s0">total_return_amount</span><span class="s2">).</span><span class="s0">fillna</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>

        <span class="s3"># Apply log transforms to reduce skewness</span>
        <span class="s0">df</span><span class="s2">[</span><span class="s4">'LogTotalPrice'</span><span class="s2">] = </span><span class="s0">np</span><span class="s2">.</span><span class="s0">log1p</span><span class="s2">(</span><span class="s0">df</span><span class="s2">[</span><span class="s4">'TotalPrice'</span><span class="s2">].</span><span class="s0">clip</span><span class="s2">(</span><span class="s0">lower</span><span class="s2">=</span><span class="s5">0</span><span class="s2">))</span>
        <span class="s0">df</span><span class="s2">[</span><span class="s4">'LogQuantity'</span><span class="s2">] = </span><span class="s0">np</span><span class="s2">.</span><span class="s0">log1p</span><span class="s2">(</span><span class="s0">df</span><span class="s2">[</span><span class="s4">'Quantity'</span><span class="s2">].</span><span class="s0">clip</span><span class="s2">(</span><span class="s0">lower</span><span class="s2">=</span><span class="s5">0</span><span class="s2">))</span>

        <span class="s3"># Check skewness after log transform</span>
        <span class="s0">log_total_price_skewness </span><span class="s2">= </span><span class="s0">df</span><span class="s2">[</span><span class="s4">'LogTotalPrice'</span><span class="s2">].</span><span class="s0">skew</span><span class="s2">()</span>
        <span class="s0">log_quantity_skewness </span><span class="s2">= </span><span class="s0">df</span><span class="s2">[</span><span class="s4">'LogQuantity'</span><span class="s2">].</span><span class="s0">skew</span><span class="s2">()</span>
        <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;LogTotalPrice Skewness:&quot;</span><span class="s2">, </span><span class="s0">log_total_price_skewness</span><span class="s2">)</span>
        <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;LogQuantity Skewness:&quot;</span><span class="s2">, </span><span class="s0">log_quantity_skewness</span><span class="s2">)</span>

        <span class="s3"># Visualize distributions of transformed features</span>
        <span class="s0">plt</span><span class="s2">.</span><span class="s0">figure</span><span class="s2">(</span><span class="s0">figsize</span><span class="s2">=(</span><span class="s5">8</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
        <span class="s0">sns</span><span class="s2">.</span><span class="s0">histplot</span><span class="s2">(</span><span class="s0">df</span><span class="s2">[</span><span class="s4">'LogTotalPrice'</span><span class="s2">].</span><span class="s0">dropna</span><span class="s2">(), </span><span class="s0">bins</span><span class="s2">=</span><span class="s5">30</span><span class="s2">, </span><span class="s0">kde</span><span class="s2">=</span><span class="s1">True</span><span class="s2">)</span>
        <span class="s0">plt</span><span class="s2">.</span><span class="s0">title</span><span class="s2">(</span><span class="s4">'LogTotalPrice Distribution'</span><span class="s2">)</span>
        <span class="s0">plt</span><span class="s2">.</span><span class="s0">xlabel</span><span class="s2">(</span><span class="s4">'LogTotalPrice'</span><span class="s2">)</span>
        <span class="s0">plt</span><span class="s2">.</span><span class="s0">ylabel</span><span class="s2">(</span><span class="s4">'Frequency'</span><span class="s2">)</span>
        <span class="s0">plt</span><span class="s2">.</span><span class="s0">show</span><span class="s2">()</span>

        <span class="s0">plt</span><span class="s2">.</span><span class="s0">figure</span><span class="s2">(</span><span class="s0">figsize</span><span class="s2">=(</span><span class="s5">8</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
        <span class="s0">sns</span><span class="s2">.</span><span class="s0">histplot</span><span class="s2">(</span><span class="s0">df</span><span class="s2">[</span><span class="s4">'ReturnRate'</span><span class="s2">].</span><span class="s0">dropna</span><span class="s2">(), </span><span class="s0">bins</span><span class="s2">=</span><span class="s5">30</span><span class="s2">, </span><span class="s0">kde</span><span class="s2">=</span><span class="s1">True</span><span class="s2">)</span>
        <span class="s0">plt</span><span class="s2">.</span><span class="s0">title</span><span class="s2">(</span><span class="s4">'ReturnRate Distribution'</span><span class="s2">)</span>
        <span class="s0">plt</span><span class="s2">.</span><span class="s0">xlabel</span><span class="s2">(</span><span class="s4">'ReturnRate'</span><span class="s2">)</span>
        <span class="s0">plt</span><span class="s2">.</span><span class="s0">ylabel</span><span class="s2">(</span><span class="s4">'Frequency'</span><span class="s2">)</span>
        <span class="s0">plt</span><span class="s2">.</span><span class="s0">show</span><span class="s2">()</span>

    <span class="s3"># Identify customers with ReturnRate &gt; 1 (could indicate data issues)</span>
    <span class="s0">high_return_customers </span><span class="s2">= </span><span class="s0">df</span><span class="s2">[</span><span class="s0">df</span><span class="s2">[</span><span class="s4">'ReturnRate'</span><span class="s2">] &gt; </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s0">display</span><span class="s2">(</span><span class="s0">high_return_customers</span><span class="s2">[[</span><span class="s4">'CustomerID'</span><span class="s2">, </span><span class="s4">'ReturnRate'</span><span class="s2">, </span><span class="s4">'ReturnCount'</span><span class="s2">, </span><span class="s4">'TotalReturnAmount'</span><span class="s2">]])</span>
    <span class="s0">high_return_customers_count </span><span class="s2">= </span><span class="s0">high_return_customers</span><span class="s2">.</span><span class="s0">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Number of customers with ReturnRate &gt; 1:&quot;</span><span class="s2">, </span><span class="s0">high_return_customers_count</span><span class="s2">)</span>

    <span class="s3"># Final shape, info, and columns after EDA steps</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Final Data Shape:&quot;</span><span class="s2">, </span><span class="s0">df</span><span class="s2">.</span><span class="s0">shape</span><span class="s2">)</span>
    <span class="s0">df</span><span class="s2">.</span><span class="s0">info</span><span class="s2">()</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Columns:&quot;</span><span class="s2">, </span><span class="s0">df</span><span class="s2">.</span><span class="s0">columns</span><span class="s2">)</span>

    <span class="s3"># Create a year-month period for time-series analysis</span>
    <span class="s0">df</span><span class="s2">[</span><span class="s4">'InvoiceYearMonth'</span><span class="s2">] = </span><span class="s0">df</span><span class="s2">[</span><span class="s4">'InvoiceDate'</span><span class="s2">].</span><span class="s0">dt</span><span class="s2">.</span><span class="s0">to_period</span><span class="s2">(</span><span class="s4">'M'</span><span class="s2">)</span>

    <span class="s3"># Monthly total sales trend</span>
    <span class="s0">monthly_sales </span><span class="s2">= </span><span class="s0">df</span><span class="s2">.</span><span class="s0">groupby</span><span class="s2">(</span><span class="s4">'InvoiceYearMonth'</span><span class="s2">)[</span><span class="s4">'TotalPrice'</span><span class="s2">].</span><span class="s0">sum</span><span class="s2">()</span>

    <span class="s0">plt</span><span class="s2">.</span><span class="s0">figure</span><span class="s2">(</span><span class="s0">figsize</span><span class="s2">=(</span><span class="s5">12</span><span class="s2">, </span><span class="s5">6</span><span class="s2">))</span>
    <span class="s0">monthly_sales</span><span class="s2">.</span><span class="s0">plot</span><span class="s2">(</span><span class="s0">kind</span><span class="s2">=</span><span class="s4">'line'</span><span class="s2">, </span><span class="s0">marker</span><span class="s2">=</span><span class="s4">'o'</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">title</span><span class="s2">(</span><span class="s4">'Monthly Sales Trend'</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">xlabel</span><span class="s2">(</span><span class="s4">'Year-Month'</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">ylabel</span><span class="s2">(</span><span class="s4">'Total Sales'</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">grid</span><span class="s2">(</span><span class="s1">True</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">xticks</span><span class="s2">(</span><span class="s0">rotation</span><span class="s2">=</span><span class="s5">45</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">show</span><span class="s2">()</span>

    <span class="s3"># Check most recent transaction date</span>
    <span class="s0">current_date </span><span class="s2">= </span><span class="s0">df</span><span class="s2">[</span><span class="s4">'InvoiceDate'</span><span class="s2">].</span><span class="s0">max</span><span class="s2">()</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Most recent transaction date:&quot;</span><span class="s2">, </span><span class="s0">current_date</span><span class="s2">)</span>

    <span class="s3">############################################################</span>
    <span class="s3"># RFM METRICS CALCULATION</span>
    <span class="s3">############################################################</span>
    <span class="s3"># Calculate RFM metrics:</span>
    <span class="s3"># - Recency: days since last purchase</span>
    <span class="s3"># - Frequency: count of unique transactions</span>
    <span class="s3"># - Monetary: total spending</span>

    <span class="s0">rfm </span><span class="s2">= </span><span class="s0">df</span><span class="s2">.</span><span class="s0">groupby</span><span class="s2">(</span><span class="s4">'CustomerID'</span><span class="s2">).</span><span class="s0">agg</span><span class="s2">(</span>
        <span class="s0">Recency</span><span class="s2">=(</span><span class="s4">'InvoiceDate'</span><span class="s2">, </span><span class="s1">lambda </span><span class="s0">x</span><span class="s2">: (</span><span class="s0">current_date </span><span class="s2">- </span><span class="s0">x</span><span class="s2">.</span><span class="s0">max</span><span class="s2">()).</span><span class="s0">days</span><span class="s2">),</span>
        <span class="s0">Frequency</span><span class="s2">=(</span><span class="s4">'InvoiceNo'</span><span class="s2">, </span><span class="s4">'nunique'</span><span class="s2">),</span>
        <span class="s0">Monetary</span><span class="s2">=(</span><span class="s4">'TotalPrice'</span><span class="s2">, </span><span class="s4">'sum'</span><span class="s2">)</span>
    <span class="s2">)</span>

    <span class="s0">display</span><span class="s2">(</span><span class="s0">rfm</span><span class="s2">.</span><span class="s0">head</span><span class="s2">())</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;RFM Statistical Summary:</span><span class="s1">\n</span><span class="s4">&quot;</span><span class="s2">, </span><span class="s0">rfm</span><span class="s2">.</span><span class="s0">describe</span><span class="s2">())</span>

    <span class="s3">############################################################</span>
    <span class="s3"># DISTRIBUTION OF RFM METRICS</span>
    <span class="s3">############################################################</span>
    <span class="s3"># Visualize Recency, Frequency, Monetary distributions</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">figure</span><span class="s2">(</span><span class="s0">figsize</span><span class="s2">=(</span><span class="s5">8</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
    <span class="s0">sns</span><span class="s2">.</span><span class="s0">histplot</span><span class="s2">(</span><span class="s0">rfm</span><span class="s2">[</span><span class="s4">'Recency'</span><span class="s2">], </span><span class="s0">kde</span><span class="s2">=</span><span class="s1">True</span><span class="s2">, </span><span class="s0">bins</span><span class="s2">=</span><span class="s5">20</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">title</span><span class="s2">(</span><span class="s4">'Recency Distribution'</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">xlabel</span><span class="s2">(</span><span class="s4">'Recency (Days)'</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">ylabel</span><span class="s2">(</span><span class="s4">'Frequency'</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">show</span><span class="s2">()</span>

    <span class="s0">plt</span><span class="s2">.</span><span class="s0">figure</span><span class="s2">(</span><span class="s0">figsize</span><span class="s2">=(</span><span class="s5">8</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
    <span class="s0">sns</span><span class="s2">.</span><span class="s0">histplot</span><span class="s2">(</span><span class="s0">rfm</span><span class="s2">[</span><span class="s4">'Frequency'</span><span class="s2">], </span><span class="s0">kde</span><span class="s2">=</span><span class="s1">True</span><span class="s2">, </span><span class="s0">bins</span><span class="s2">=</span><span class="s5">20</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">title</span><span class="s2">(</span><span class="s4">'Frequency Distribution'</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">xlabel</span><span class="s2">(</span><span class="s4">'Frequency (Number of unique transactions)'</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">ylabel</span><span class="s2">(</span><span class="s4">'Frequency'</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">show</span><span class="s2">()</span>

    <span class="s0">plt</span><span class="s2">.</span><span class="s0">figure</span><span class="s2">(</span><span class="s0">figsize</span><span class="s2">=(</span><span class="s5">8</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
    <span class="s0">sns</span><span class="s2">.</span><span class="s0">histplot</span><span class="s2">(</span><span class="s0">rfm</span><span class="s2">[</span><span class="s4">'Monetary'</span><span class="s2">], </span><span class="s0">kde</span><span class="s2">=</span><span class="s1">True</span><span class="s2">, </span><span class="s0">bins</span><span class="s2">=</span><span class="s5">20</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">title</span><span class="s2">(</span><span class="s4">'Monetary Distribution'</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">xlabel</span><span class="s2">(</span><span class="s4">'Monetary (Total spending)'</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">ylabel</span><span class="s2">(</span><span class="s4">'Frequency'</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">show</span><span class="s2">()</span>

    <span class="s3"># AvgOrderValue = Monetary / Frequency</span>
    <span class="s0">rfm</span><span class="s2">[</span><span class="s4">'AvgOrderValue'</span><span class="s2">] = </span><span class="s0">rfm</span><span class="s2">[</span><span class="s4">'Monetary'</span><span class="s2">] / </span><span class="s0">rfm</span><span class="s2">[</span><span class="s4">'Frequency'</span><span class="s2">]</span>


    <span class="s3"># Encode Country column for modeling purposes</span>
    <span class="s0">df</span><span class="s2">[</span><span class="s4">'Country'</span><span class="s2">] = </span><span class="s0">pd</span><span class="s2">.</span><span class="s0">factorize</span><span class="s2">(</span><span class="s0">df</span><span class="s2">[</span><span class="s4">'Country'</span><span class="s2">])[</span><span class="s5">0</span><span class="s2">]</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Columns after encoding Country:</span><span class="s1">\n</span><span class="s4">&quot;</span><span class="s2">, </span><span class="s0">df</span><span class="s2">.</span><span class="s0">columns</span><span class="s2">)</span>
    <span class="s0">df</span><span class="s2">.</span><span class="s0">shape</span>



    <span class="s3">############################################################</span>
    <span class="s3"># 0. IMPORTS &amp; SETUP</span>
    <span class="s3">############################################################</span>
    <span class="s1">import </span><span class="s0">pandas </span><span class="s1">as </span><span class="s0">pd</span>
    <span class="s1">import </span><span class="s0">numpy </span><span class="s1">as </span><span class="s0">np</span>
    <span class="s1">import </span><span class="s0">os</span>
    <span class="s1">import </span><span class="s0">seaborn </span><span class="s1">as </span><span class="s0">sns</span>
    <span class="s1">import </span><span class="s0">matplotlib</span><span class="s2">.</span><span class="s0">pyplot </span><span class="s1">as </span><span class="s0">plt</span>
    <span class="s1">import </span><span class="s0">warnings</span>

    <span class="s3"># Sklearn &amp; Statsmodels</span>
    <span class="s1">from </span><span class="s0">sklearn</span><span class="s2">.</span><span class="s0">preprocessing </span><span class="s1">import </span><span class="s0">StandardScaler</span><span class="s2">, </span><span class="s0">OneHotEncoder</span><span class="s2">, </span><span class="s0">LabelEncoder</span>
    <span class="s1">from </span><span class="s0">sklearn</span><span class="s2">.</span><span class="s0">cluster </span><span class="s1">import </span><span class="s0">KMeans</span>
    <span class="s1">from </span><span class="s0">sklearn</span><span class="s2">.</span><span class="s0">decomposition </span><span class="s1">import </span><span class="s0">PCA</span>
    <span class="s1">from </span><span class="s0">sklearn</span><span class="s2">.</span><span class="s0">model_selection </span><span class="s1">import </span><span class="s2">(</span>
        <span class="s0">train_test_split</span><span class="s2">,</span>
        <span class="s0">GridSearchCV</span><span class="s2">,</span>
        <span class="s0">RandomizedSearchCV</span><span class="s2">,</span>
        <span class="s0">cross_validate</span>
    <span class="s2">)</span>
    <span class="s1">from </span><span class="s0">sklearn</span><span class="s2">.</span><span class="s0">ensemble </span><span class="s1">import </span><span class="s2">(</span>
        <span class="s0">GradientBoostingRegressor</span><span class="s2">,</span>
        <span class="s0">RandomForestRegressor</span>
    <span class="s2">)</span>
    <span class="s1">from </span><span class="s0">sklearn</span><span class="s2">.</span><span class="s0">metrics </span><span class="s1">import </span><span class="s2">(</span>
        <span class="s0">mean_squared_error</span><span class="s2">,</span>
        <span class="s0">silhouette_score</span><span class="s2">,</span>
        <span class="s0">calinski_harabasz_score</span>
    <span class="s2">)</span>
    <span class="s1">from </span><span class="s0">sklearn</span><span class="s2">.</span><span class="s0">metrics</span><span class="s2">.</span><span class="s0">pairwise </span><span class="s1">import </span><span class="s0">cosine_similarity</span>

    <span class="s1">import </span><span class="s0">statsmodels</span><span class="s2">.</span><span class="s0">api </span><span class="s1">as </span><span class="s0">sm</span>
    <span class="s1">from </span><span class="s0">statsmodels</span><span class="s2">.</span><span class="s0">stats</span><span class="s2">.</span><span class="s0">outliers_influence </span><span class="s1">import </span><span class="s0">variance_inflation_factor</span>

    <span class="s3"># Prophet (Time Series)</span>
    <span class="s1">from </span><span class="s0">prophet </span><span class="s1">import </span><span class="s0">Prophet</span>
    <span class="s1">import </span><span class="s0">math</span>

    <span class="s0">warnings</span><span class="s2">.</span><span class="s0">filterwarnings</span><span class="s2">(</span><span class="s4">&quot;ignore&quot;</span><span class="s2">)</span>

    <span class="s3"># (Opsiyonel) XGBoost, LightGBM, CatBoost kontrol</span>
    <span class="s1">try</span><span class="s2">:</span>
        <span class="s1">from </span><span class="s0">xgboost </span><span class="s1">import </span><span class="s0">XGBRegressor</span>

        <span class="s0">xgb_installed </span><span class="s2">= </span><span class="s1">True</span>
    <span class="s1">except </span><span class="s0">ImportError</span><span class="s2">:</span>
        <span class="s0">xgb_installed </span><span class="s2">= </span><span class="s1">False</span>

    <span class="s1">try</span><span class="s2">:</span>
        <span class="s1">from </span><span class="s0">lightgbm </span><span class="s1">import </span><span class="s0">LGBMRegressor</span>

        <span class="s0">lgb_installed </span><span class="s2">= </span><span class="s1">True</span>
    <span class="s1">except </span><span class="s0">ImportError</span><span class="s2">:</span>
        <span class="s0">lgb_installed </span><span class="s2">= </span><span class="s1">False</span>

    <span class="s1">try</span><span class="s2">:</span>
        <span class="s1">from </span><span class="s0">catboost </span><span class="s1">import </span><span class="s0">CatBoostRegressor</span>

        <span class="s0">cat_installed </span><span class="s2">= </span><span class="s1">True</span>
    <span class="s1">except </span><span class="s0">ImportError</span><span class="s2">:</span>
        <span class="s0">cat_installed </span><span class="s2">= </span><span class="s1">False</span>

    <span class="s3">############################################################</span>
    <span class="s3"># 1. LOAD &amp; CLEAN DATA</span>
    <span class="s3">############################################################</span>
    <span class="s4">&quot;&quot;&quot; 
    ADIM 1: 
    - df veri setini yüklediğimizi varsayıyoruz (df tanımlı). 
    - InvoiceDate'i datetime tipine çevirip geçersiz tarihleri silme. 
    - Duplikat kayıtları silme. 
    - TotalPrice yoksa (Quantity*UnitPrice) hesabı. 
    &quot;&quot;&quot;</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Initial DataFrame Columns:</span><span class="s1">\n</span><span class="s4">&quot;</span><span class="s2">, </span><span class="s0">df</span><span class="s2">.</span><span class="s0">columns</span><span class="s2">)</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Preview of the DataFrame:</span><span class="s1">\n</span><span class="s4">&quot;</span><span class="s2">, </span><span class="s0">df</span><span class="s2">.</span><span class="s0">head</span><span class="s2">())</span>

    <span class="s1">if not </span><span class="s0">pd</span><span class="s2">.</span><span class="s0">api</span><span class="s2">.</span><span class="s0">types</span><span class="s2">.</span><span class="s0">is_datetime64_any_dtype</span><span class="s2">(</span><span class="s0">df</span><span class="s2">[</span><span class="s4">'InvoiceDate'</span><span class="s2">]):</span>
        <span class="s0">df</span><span class="s2">[</span><span class="s4">'InvoiceDate'</span><span class="s2">] = </span><span class="s0">pd</span><span class="s2">.</span><span class="s0">to_datetime</span><span class="s2">(</span><span class="s0">df</span><span class="s2">[</span><span class="s4">'InvoiceDate'</span><span class="s2">], </span><span class="s0">errors</span><span class="s2">=</span><span class="s4">'coerce'</span><span class="s2">)</span>

    <span class="s0">initial_rows </span><span class="s2">= </span><span class="s0">len</span><span class="s2">(</span><span class="s0">df</span><span class="s2">)</span>
    <span class="s0">df</span><span class="s2">.</span><span class="s0">dropna</span><span class="s2">(</span><span class="s0">subset</span><span class="s2">=[</span><span class="s4">'InvoiceDate'</span><span class="s2">], </span><span class="s0">inplace</span><span class="s2">=</span><span class="s1">True</span><span class="s2">)</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">f&quot;Dropped </span><span class="s1">{</span><span class="s0">initial_rows </span><span class="s2">- </span><span class="s0">len</span><span class="s2">(</span><span class="s0">df</span><span class="s2">)</span><span class="s1">} </span><span class="s4">rows with invalid InvoiceDate.&quot;</span><span class="s2">)</span>

    <span class="s0">before_duplicates </span><span class="s2">= </span><span class="s0">len</span><span class="s2">(</span><span class="s0">df</span><span class="s2">)</span>
    <span class="s0">df</span><span class="s2">.</span><span class="s0">drop_duplicates</span><span class="s2">(</span><span class="s0">inplace</span><span class="s2">=</span><span class="s1">True</span><span class="s2">)</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">f&quot;Dropped </span><span class="s1">{</span><span class="s0">before_duplicates </span><span class="s2">- </span><span class="s0">len</span><span class="s2">(</span><span class="s0">df</span><span class="s2">)</span><span class="s1">} </span><span class="s4">duplicate rows.&quot;</span><span class="s2">)</span>

    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Data after cleaning:</span><span class="s1">\n</span><span class="s4">&quot;</span><span class="s2">, </span><span class="s0">df</span><span class="s2">.</span><span class="s0">head</span><span class="s2">())</span>

    <span class="s1">if </span><span class="s4">'TotalPrice' </span><span class="s1">not in </span><span class="s0">df</span><span class="s2">.</span><span class="s0">columns</span><span class="s2">:</span>
        <span class="s0">df</span><span class="s2">[</span><span class="s4">'TotalPrice'</span><span class="s2">] = </span><span class="s0">df</span><span class="s2">[</span><span class="s4">'Quantity'</span><span class="s2">] * </span><span class="s0">df</span><span class="s2">[</span><span class="s4">'UnitPrice'</span><span class="s2">]</span>
        <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Calculated TotalPrice.</span><span class="s1">\n</span><span class="s4">&quot;</span><span class="s2">, </span><span class="s0">df</span><span class="s2">[[</span><span class="s4">'Quantity'</span><span class="s2">, </span><span class="s4">'UnitPrice'</span><span class="s2">, </span><span class="s4">'TotalPrice'</span><span class="s2">]].</span><span class="s0">head</span><span class="s2">())</span>

    <span class="s3">############################################################</span>
    <span class="s3"># 2. SEPARATE RETURNS &amp; POSITIVE SALES</span>
    <span class="s3">############################################################</span>
    <span class="s4">&quot;&quot;&quot; 
    ADIM 2: 
    - İadeleri (Quantity&lt;0 veya TotalPrice&lt;0) returns_df'e al. 
    - Pozitif kayıtlar non_returns_df. 
    - ReturnRate, ReturnCount gibi metrikleri hesapla. 
    - purchase_data.csv -&gt; (müşteri, ürün) bazında PurchaseAmount, öneri sistemi için pivot. 
    &quot;&quot;&quot;</span>
    <span class="s0">returns_df </span><span class="s2">= </span><span class="s0">df</span><span class="s2">[(</span><span class="s0">df</span><span class="s2">[</span><span class="s4">'Quantity'</span><span class="s2">] &lt; </span><span class="s5">0</span><span class="s2">) | (</span><span class="s0">df</span><span class="s2">[</span><span class="s4">'TotalPrice'</span><span class="s2">] &lt; </span><span class="s5">0</span><span class="s2">)]</span>
    <span class="s0">non_returns_df </span><span class="s2">= </span><span class="s0">df</span><span class="s2">[(</span><span class="s0">df</span><span class="s2">[</span><span class="s4">'Quantity'</span><span class="s2">] &gt;= </span><span class="s5">0</span><span class="s2">) &amp; (</span><span class="s0">df</span><span class="s2">[</span><span class="s4">'TotalPrice'</span><span class="s2">] &gt;= </span><span class="s5">0</span><span class="s2">)]</span>

    <span class="s0">total_quantity </span><span class="s2">= </span><span class="s0">non_returns_df</span><span class="s2">.</span><span class="s0">groupby</span><span class="s2">(</span><span class="s4">'CustomerID'</span><span class="s2">)[</span><span class="s4">'Quantity'</span><span class="s2">].</span><span class="s0">sum</span><span class="s2">()</span>
    <span class="s0">total_revenue </span><span class="s2">= </span><span class="s0">non_returns_df</span><span class="s2">.</span><span class="s0">groupby</span><span class="s2">(</span><span class="s4">'CustomerID'</span><span class="s2">)[</span><span class="s4">'TotalPrice'</span><span class="s2">].</span><span class="s0">sum</span><span class="s2">()</span>

    <span class="s0">returned_quantity </span><span class="s2">= </span><span class="s0">returns_df</span><span class="s2">.</span><span class="s0">groupby</span><span class="s2">(</span><span class="s4">'CustomerID'</span><span class="s2">)[</span><span class="s4">'Quantity'</span><span class="s2">].</span><span class="s0">sum</span><span class="s2">().</span><span class="s0">abs</span><span class="s2">()</span>
    <span class="s0">returned_amount </span><span class="s2">= </span><span class="s0">returns_df</span><span class="s2">.</span><span class="s0">groupby</span><span class="s2">(</span><span class="s4">'CustomerID'</span><span class="s2">)[</span><span class="s4">'TotalPrice'</span><span class="s2">].</span><span class="s0">sum</span><span class="s2">().</span><span class="s0">abs</span><span class="s2">()</span>

    <span class="s0">return_rate </span><span class="s2">= (</span><span class="s0">returned_quantity </span><span class="s2">/ </span><span class="s0">total_quantity</span><span class="s2">).</span><span class="s0">fillna</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s0">return_count </span><span class="s2">= </span><span class="s0">returns_df</span><span class="s2">.</span><span class="s0">groupby</span><span class="s2">(</span><span class="s4">'CustomerID'</span><span class="s2">).</span><span class="s0">size</span><span class="s2">()</span>

    <span class="s0">purchase_data </span><span class="s2">= </span><span class="s0">non_returns_df</span><span class="s2">.</span><span class="s0">groupby</span><span class="s2">([</span><span class="s4">'CustomerID'</span><span class="s2">, </span><span class="s4">'StockCode'</span><span class="s2">], </span><span class="s0">as_index</span><span class="s2">=</span><span class="s1">False</span><span class="s2">).</span><span class="s0">agg</span><span class="s2">({</span><span class="s4">'TotalPrice'</span><span class="s2">: </span><span class="s4">'sum'</span><span class="s2">})</span>
    <span class="s0">purchase_data</span><span class="s2">.</span><span class="s0">rename</span><span class="s2">(</span><span class="s0">columns</span><span class="s2">={</span><span class="s4">'StockCode'</span><span class="s2">: </span><span class="s4">'ProductID'</span><span class="s2">, </span><span class="s4">'TotalPrice'</span><span class="s2">: </span><span class="s4">'PurchaseAmount'</span><span class="s2">}, </span><span class="s0">inplace</span><span class="s2">=</span><span class="s1">True</span><span class="s2">)</span>
    <span class="s0">purchase_data</span><span class="s2">.</span><span class="s0">to_csv</span><span class="s2">(</span><span class="s4">&quot;purchase_data.csv&quot;</span><span class="s2">, </span><span class="s0">index</span><span class="s2">=</span><span class="s1">False</span><span class="s2">)</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Created purchase_data.csv from non_returns_df successfully!&quot;</span><span class="s2">)</span>

    <span class="s3">############################################################</span>
    <span class="s3"># 3. RFM METRICS &amp; EXTRA FEATURES</span>
    <span class="s3">############################################################</span>
    <span class="s4">&quot;&quot;&quot; 
    ADIM 3: 
    - RFM: Recency, Frequency, Monetary 
    - ReturnRate, ReturnCount, TotalReturnAmount, AvgOrderValue 
    - CLV (indirimli), LoyaltyScore 
    &quot;&quot;&quot;</span>
    <span class="s0">current_date </span><span class="s2">= </span><span class="s0">df</span><span class="s2">[</span><span class="s4">'InvoiceDate'</span><span class="s2">].</span><span class="s0">max</span><span class="s2">()</span>
    <span class="s0">max_date </span><span class="s2">= </span><span class="s0">current_date</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Max Invoice Date in dataset:&quot;</span><span class="s2">, </span><span class="s0">max_date</span><span class="s2">)</span>

    <span class="s0">rfm </span><span class="s2">= </span><span class="s0">non_returns_df</span><span class="s2">.</span><span class="s0">groupby</span><span class="s2">(</span><span class="s4">'CustomerID'</span><span class="s2">).</span><span class="s0">agg</span><span class="s2">(</span>
        <span class="s0">Recency</span><span class="s2">=(</span><span class="s4">'InvoiceDate'</span><span class="s2">, </span><span class="s1">lambda </span><span class="s0">x</span><span class="s2">: (</span><span class="s0">max_date </span><span class="s2">- </span><span class="s0">x</span><span class="s2">.</span><span class="s0">max</span><span class="s2">()).</span><span class="s0">days</span><span class="s2">),</span>
        <span class="s0">Frequency</span><span class="s2">=(</span><span class="s4">'InvoiceNo'</span><span class="s2">, </span><span class="s4">'nunique'</span><span class="s2">),</span>
        <span class="s0">Monetary</span><span class="s2">=(</span><span class="s4">'TotalPrice'</span><span class="s2">, </span><span class="s4">'sum'</span><span class="s2">)</span>
    <span class="s2">).</span><span class="s0">reset_index</span><span class="s2">()</span>

    <span class="s0">rfm</span><span class="s2">[</span><span class="s4">'ReturnRate'</span><span class="s2">] = </span><span class="s0">rfm</span><span class="s2">[</span><span class="s4">'CustomerID'</span><span class="s2">].</span><span class="s0">map</span><span class="s2">(</span><span class="s0">return_rate</span><span class="s2">).</span><span class="s0">fillna</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s0">rfm</span><span class="s2">[</span><span class="s4">'ReturnCount'</span><span class="s2">] = </span><span class="s0">rfm</span><span class="s2">[</span><span class="s4">'CustomerID'</span><span class="s2">].</span><span class="s0">map</span><span class="s2">(</span><span class="s0">return_count</span><span class="s2">).</span><span class="s0">fillna</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s0">rfm</span><span class="s2">[</span><span class="s4">'TotalReturnAmount'</span><span class="s2">] = </span><span class="s0">rfm</span><span class="s2">[</span><span class="s4">'CustomerID'</span><span class="s2">].</span><span class="s0">map</span><span class="s2">(</span><span class="s0">returned_amount</span><span class="s2">).</span><span class="s0">fillna</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s0">rfm</span><span class="s2">[</span><span class="s4">'AvgOrderValue'</span><span class="s2">] = </span><span class="s0">np</span><span class="s2">.</span><span class="s0">where</span><span class="s2">(</span><span class="s0">rfm</span><span class="s2">[</span><span class="s4">'Frequency'</span><span class="s2">] == </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s0">rfm</span><span class="s2">[</span><span class="s4">'Monetary'</span><span class="s2">] / </span><span class="s0">rfm</span><span class="s2">[</span><span class="s4">'Frequency'</span><span class="s2">])</span>

    <span class="s0">discount_rate </span><span class="s2">= </span><span class="s5">0.10</span>
    <span class="s0">years </span><span class="s2">= </span><span class="s5">3</span>
    <span class="s0">discount_factors </span><span class="s2">= </span><span class="s0">sum</span><span class="s2">([</span><span class="s5">1 </span><span class="s2">/ ((</span><span class="s5">1 </span><span class="s2">+ </span><span class="s0">discount_rate</span><span class="s2">) ** </span><span class="s0">t</span><span class="s2">) </span><span class="s1">for </span><span class="s0">t </span><span class="s1">in </span><span class="s0">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s0">years </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">)])</span>
    <span class="s0">rfm</span><span class="s2">[</span><span class="s4">'CLV'</span><span class="s2">] = </span><span class="s0">rfm</span><span class="s2">[</span><span class="s4">'AvgOrderValue'</span><span class="s2">] * </span><span class="s0">rfm</span><span class="s2">[</span><span class="s4">'Frequency'</span><span class="s2">] * </span><span class="s0">discount_factors</span>

    <span class="s0">rfm</span><span class="s2">[</span><span class="s4">'LoyaltyScore'</span><span class="s2">] = </span><span class="s0">rfm</span><span class="s2">[</span><span class="s4">'Frequency'</span><span class="s2">] * (</span><span class="s5">1 </span><span class="s2">/ (</span><span class="s5">1 </span><span class="s2">+ </span><span class="s0">rfm</span><span class="s2">[</span><span class="s4">'ReturnRate'</span><span class="s2">]))</span>

    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;RFM after aggregation &amp; extra features:</span><span class="s1">\n</span><span class="s4">&quot;</span><span class="s2">, </span><span class="s0">rfm</span><span class="s2">.</span><span class="s0">head</span><span class="s2">())</span>

    <span class="s3">############################################################</span>
    <span class="s3"># 4. TIME FEATURES (MONTH, QUARTER, SEASON)</span>
    <span class="s3">############################################################</span>
    <span class="s4">&quot;&quot;&quot; 
    ADIM 4: 
    - Son alışveriş tarihine göre Month, Quarter, Season 
    - One-Hot encoder ile bu sütunları dönüştürüyoruz 
    &quot;&quot;&quot;</span>
    <span class="s0">last_invoice </span><span class="s2">= </span><span class="s0">non_returns_df</span><span class="s2">.</span><span class="s0">groupby</span><span class="s2">(</span><span class="s4">'CustomerID'</span><span class="s2">)[</span><span class="s4">'InvoiceDate'</span><span class="s2">].</span><span class="s0">max</span><span class="s2">()</span>
    <span class="s0">rfm</span><span class="s2">[</span><span class="s4">'ShoppingTime'</span><span class="s2">] = </span><span class="s0">rfm</span><span class="s2">[</span><span class="s4">'CustomerID'</span><span class="s2">].</span><span class="s0">map</span><span class="s2">(</span><span class="s0">last_invoice</span><span class="s2">)</span>
    <span class="s0">rfm</span><span class="s2">[</span><span class="s4">'ShoppingMonth'</span><span class="s2">] = </span><span class="s0">rfm</span><span class="s2">[</span><span class="s4">'ShoppingTime'</span><span class="s2">].</span><span class="s0">dt</span><span class="s2">.</span><span class="s0">month</span><span class="s2">.</span><span class="s0">astype</span><span class="s2">(</span><span class="s0">str</span><span class="s2">)</span>
    <span class="s0">rfm</span><span class="s2">[</span><span class="s4">'ShoppingQuarter'</span><span class="s2">] = </span><span class="s0">rfm</span><span class="s2">[</span><span class="s4">'ShoppingTime'</span><span class="s2">].</span><span class="s0">dt</span><span class="s2">.</span><span class="s0">quarter</span><span class="s2">.</span><span class="s0">astype</span><span class="s2">(</span><span class="s0">str</span><span class="s2">)</span>

    <span class="s0">season_map </span><span class="s2">= {</span><span class="s4">'1'</span><span class="s2">: </span><span class="s4">'Winter'</span><span class="s2">, </span><span class="s4">'2'</span><span class="s2">: </span><span class="s4">'Spring'</span><span class="s2">, </span><span class="s4">'3'</span><span class="s2">: </span><span class="s4">'Summer'</span><span class="s2">, </span><span class="s4">'4'</span><span class="s2">: </span><span class="s4">'Autumn'</span><span class="s2">}</span>
    <span class="s0">rfm</span><span class="s2">[</span><span class="s4">'Season'</span><span class="s2">] = </span><span class="s0">rfm</span><span class="s2">[</span><span class="s4">'ShoppingQuarter'</span><span class="s2">].</span><span class="s0">map</span><span class="s2">(</span><span class="s0">season_map</span><span class="s2">)</span>

    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Unique ShoppingMonths:&quot;</span><span class="s2">, </span><span class="s0">rfm</span><span class="s2">[</span><span class="s4">'ShoppingMonth'</span><span class="s2">].</span><span class="s0">unique</span><span class="s2">())</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Unique ShoppingQuarters:&quot;</span><span class="s2">, </span><span class="s0">rfm</span><span class="s2">[</span><span class="s4">'ShoppingQuarter'</span><span class="s2">].</span><span class="s0">unique</span><span class="s2">())</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Unique Seasons:&quot;</span><span class="s2">, </span><span class="s0">rfm</span><span class="s2">[</span><span class="s4">'Season'</span><span class="s2">].</span><span class="s0">unique</span><span class="s2">())</span>

    <span class="s0">encoder </span><span class="s2">= </span><span class="s0">OneHotEncoder</span><span class="s2">(</span><span class="s0">sparse_output</span><span class="s2">=</span><span class="s1">False</span><span class="s2">, </span><span class="s0">handle_unknown</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">)</span>
    <span class="s0">time_features </span><span class="s2">= </span><span class="s0">rfm</span><span class="s2">[[</span><span class="s4">'ShoppingMonth'</span><span class="s2">, </span><span class="s4">'ShoppingQuarter'</span><span class="s2">, </span><span class="s4">'Season'</span><span class="s2">]]</span>
    <span class="s0">encoded_time </span><span class="s2">= </span><span class="s0">encoder</span><span class="s2">.</span><span class="s0">fit_transform</span><span class="s2">(</span><span class="s0">time_features</span><span class="s2">)</span>
    <span class="s0">time_columns </span><span class="s2">= </span><span class="s0">encoder</span><span class="s2">.</span><span class="s0">get_feature_names_out</span><span class="s2">([</span><span class="s4">'ShoppingMonth'</span><span class="s2">, </span><span class="s4">'ShoppingQuarter'</span><span class="s2">, </span><span class="s4">'Season'</span><span class="s2">])</span>
    <span class="s0">time_df </span><span class="s2">= </span><span class="s0">pd</span><span class="s2">.</span><span class="s0">DataFrame</span><span class="s2">(</span><span class="s0">encoded_time</span><span class="s2">, </span><span class="s0">columns</span><span class="s2">=</span><span class="s0">time_columns</span><span class="s2">, </span><span class="s0">index</span><span class="s2">=</span><span class="s0">rfm</span><span class="s2">.</span><span class="s0">index</span><span class="s2">)</span>

    <span class="s0">rfm </span><span class="s2">= </span><span class="s0">pd</span><span class="s2">.</span><span class="s0">concat</span><span class="s2">([</span><span class="s0">rfm</span><span class="s2">, </span><span class="s0">time_df</span><span class="s2">], </span><span class="s0">axis</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;RFM with time-based one-hot encoding (including Season):</span><span class="s1">\n</span><span class="s4">&quot;</span><span class="s2">, </span><span class="s0">rfm</span><span class="s2">.</span><span class="s0">head</span><span class="s2">())</span>

    <span class="s3">############################################################</span>
    <span class="s3"># 5. SCALING FOR CLUSTERING (MULTICOLLINEARITY REDUCTION)</span>
    <span class="s3">############################################################</span>
    <span class="s4">&quot;&quot;&quot; 
    ADIM 5: 
    - Multicollinearity sorunu (VIF) incelendiğinde Monetary ve CLV vb. çok yüksek VIF çıkıyordu. 
    - Burada Monetary'yi çıkararak collinearity'i bir miktar azaltıyoruz  
      (veya Monetary yerine CLV'yi çıkarmak da tercih edilebilir). 
    - numeric_features -&gt; 'Monetary' kaldırılsın.  
    &quot;&quot;&quot;</span>
    <span class="s3"># Orijinalde: ['Recency','Frequency','Monetary','ReturnRate','CLV','LoyaltyScore','AvgOrderValue']</span>
    <span class="s3"># 'Monetary' -&gt; remove to reduce collinearity</span>

    <span class="s0">numeric_features </span><span class="s2">= [</span>
        <span class="s4">'Recency'</span><span class="s2">, </span><span class="s4">'Frequency'</span><span class="s2">, </span><span class="s4">'ReturnRate'</span><span class="s2">, </span><span class="s4">'CLV'</span><span class="s2">,</span>
        <span class="s4">'LoyaltyScore'</span><span class="s2">, </span><span class="s4">'AvgOrderValue'</span>
    <span class="s2">]</span>
    <span class="s0">categorical_features </span><span class="s2">= </span><span class="s0">time_df</span><span class="s2">.</span><span class="s0">columns</span><span class="s2">.</span><span class="s0">tolist</span><span class="s2">()</span>


    <span class="s3"># VIF check (opsiyonel) - Monetary çıkardık</span>
    <span class="s1">def </span><span class="s0">check_multicollinearity</span><span class="s2">(</span><span class="s0">df</span><span class="s2">, </span><span class="s0">threshold</span><span class="s2">=</span><span class="s5">5.0</span><span class="s2">):</span>
        <span class="s0">numeric_df </span><span class="s2">= </span><span class="s0">df</span><span class="s2">.</span><span class="s0">select_dtypes</span><span class="s2">(</span><span class="s0">include</span><span class="s2">=[</span><span class="s0">np</span><span class="s2">.</span><span class="s0">number</span><span class="s2">]).</span><span class="s0">dropna</span><span class="s2">(</span><span class="s0">axis</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>
        <span class="s0">X </span><span class="s2">= </span><span class="s0">sm</span><span class="s2">.</span><span class="s0">add_constant</span><span class="s2">(</span><span class="s0">numeric_df</span><span class="s2">)</span>
        <span class="s0">vif_data </span><span class="s2">= []</span>
        <span class="s1">for </span><span class="s0">i </span><span class="s1">in </span><span class="s0">range</span><span class="s2">(</span><span class="s0">X</span><span class="s2">.</span><span class="s0">shape</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]):</span>
            <span class="s0">vif_val </span><span class="s2">= </span><span class="s0">variance_inflation_factor</span><span class="s2">(</span><span class="s0">X</span><span class="s2">.</span><span class="s0">values</span><span class="s2">, </span><span class="s0">i</span><span class="s2">)</span>
            <span class="s0">vif_data</span><span class="s2">.</span><span class="s0">append</span><span class="s2">((</span><span class="s0">X</span><span class="s2">.</span><span class="s0">columns</span><span class="s2">[</span><span class="s0">i</span><span class="s2">], </span><span class="s0">vif_val</span><span class="s2">))</span>
        <span class="s0">vif_df </span><span class="s2">= </span><span class="s0">pd</span><span class="s2">.</span><span class="s0">DataFrame</span><span class="s2">(</span><span class="s0">vif_data</span><span class="s2">, </span><span class="s0">columns</span><span class="s2">=[</span><span class="s4">'Feature'</span><span class="s2">, </span><span class="s4">'VIF'</span><span class="s2">])</span>
        <span class="s0">high_vif </span><span class="s2">= </span><span class="s0">vif_df</span><span class="s2">[</span><span class="s0">vif_df</span><span class="s2">[</span><span class="s4">'VIF'</span><span class="s2">] &gt; </span><span class="s0">threshold</span><span class="s2">]</span>
        <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;</span><span class="s1">\n</span><span class="s4">--- VIF Results ---</span><span class="s1">\n</span><span class="s4">&quot;</span><span class="s2">, </span><span class="s0">vif_df</span><span class="s2">)</span>
        <span class="s1">if not </span><span class="s0">high_vif</span><span class="s2">.</span><span class="s0">empty</span><span class="s2">:</span>
            <span class="s0">print</span><span class="s2">(</span><span class="s4">f&quot;</span><span class="s1">\n</span><span class="s4">Features with VIF &gt; </span><span class="s1">{</span><span class="s0">threshold</span><span class="s1">}</span><span class="s4">:</span><span class="s1">\n</span><span class="s4">&quot;</span><span class="s2">, </span><span class="s0">high_vif</span><span class="s2">)</span>
            <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Suggestion: Consider removing or transforming these features.&quot;</span><span class="s2">)</span>
        <span class="s1">else</span><span class="s2">:</span>
            <span class="s0">print</span><span class="s2">(</span><span class="s4">f&quot;</span><span class="s1">\n</span><span class="s4">No features with VIF&gt;</span><span class="s1">{</span><span class="s0">threshold</span><span class="s1">}</span><span class="s4">.&quot;</span><span class="s2">)</span>
        <span class="s1">return </span><span class="s0">vif_df</span>


    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;</span><span class="s1">\n</span><span class="s4">=== Checking VIF after removing 'Monetary' ===&quot;</span><span class="s2">)</span>
    <span class="s0">vif_result </span><span class="s2">= </span><span class="s0">check_multicollinearity</span><span class="s2">(</span><span class="s0">rfm</span><span class="s2">[</span><span class="s0">numeric_features</span><span class="s2">], </span><span class="s0">threshold</span><span class="s2">=</span><span class="s5">5.0</span><span class="s2">)</span>

    <span class="s3"># Scale</span>
    <span class="s0">scaler </span><span class="s2">= </span><span class="s0">StandardScaler</span><span class="s2">()</span>
    <span class="s0">scaled_numeric </span><span class="s2">= </span><span class="s0">scaler</span><span class="s2">.</span><span class="s0">fit_transform</span><span class="s2">(</span><span class="s0">rfm</span><span class="s2">[</span><span class="s0">numeric_features</span><span class="s2">])</span>
    <span class="s0">scaled_df </span><span class="s2">= </span><span class="s0">pd</span><span class="s2">.</span><span class="s0">DataFrame</span><span class="s2">(</span><span class="s0">scaled_numeric</span><span class="s2">, </span><span class="s0">columns</span><span class="s2">=</span><span class="s0">numeric_features</span><span class="s2">, </span><span class="s0">index</span><span class="s2">=</span><span class="s0">rfm</span><span class="s2">.</span><span class="s0">index</span><span class="s2">)</span>

    <span class="s3"># Birleştir</span>
    <span class="s0">cluster_features </span><span class="s2">= </span><span class="s0">pd</span><span class="s2">.</span><span class="s0">concat</span><span class="s2">([</span><span class="s0">scaled_df</span><span class="s2">, </span><span class="s0">rfm</span><span class="s2">[</span><span class="s0">categorical_features</span><span class="s2">]], </span><span class="s0">axis</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Cluster Features shape:&quot;</span><span class="s2">, </span><span class="s0">cluster_features</span><span class="s2">.</span><span class="s0">shape</span><span class="s2">)</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Cluster Features preview:</span><span class="s1">\n</span><span class="s4">&quot;</span><span class="s2">, </span><span class="s0">cluster_features</span><span class="s2">.</span><span class="s0">head</span><span class="s2">())</span>

    <span class="s3">############################################################</span>
    <span class="s3"># 6. PCA</span>
    <span class="s3">############################################################</span>
    <span class="s0">pca </span><span class="s2">= </span><span class="s0">PCA</span><span class="s2">(</span><span class="s0">n_components</span><span class="s2">=</span><span class="s5">5</span><span class="s2">)</span>
    <span class="s0">pca_fit </span><span class="s2">= </span><span class="s0">pca</span><span class="s2">.</span><span class="s0">fit</span><span class="s2">(</span><span class="s0">cluster_features</span><span class="s2">)</span>
    <span class="s0">explained_variance </span><span class="s2">= </span><span class="s0">pca_fit</span><span class="s2">.</span><span class="s0">explained_variance_ratio_</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Explained variance by first 5 components:&quot;</span><span class="s2">, </span><span class="s0">explained_variance</span><span class="s2">)</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Cumulative:&quot;</span><span class="s2">, </span><span class="s0">explained_variance</span><span class="s2">.</span><span class="s0">cumsum</span><span class="s2">())</span>

    <span class="s0">pca_2 </span><span class="s2">= </span><span class="s0">PCA</span><span class="s2">(</span><span class="s0">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s0">rfm_pca </span><span class="s2">= </span><span class="s0">pca_2</span><span class="s2">.</span><span class="s0">fit_transform</span><span class="s2">(</span><span class="s0">cluster_features</span><span class="s2">)</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;PCA-reduced features shape:&quot;</span><span class="s2">, </span><span class="s0">rfm_pca</span><span class="s2">.</span><span class="s0">shape</span><span class="s2">)</span>

    <span class="s3">############################################################</span>
    <span class="s3"># 7. DETERMINE CLUSTERS (k=5)</span>
    <span class="s3">############################################################</span>
    <span class="s4">&quot;&quot;&quot; 
    Silhouette skorlarına göre k=5 en iyi.  
    Burada direkt k=5 seçeceğiz. 
    &quot;&quot;&quot;</span>
    <span class="s0">kmeans </span><span class="s2">= </span><span class="s0">KMeans</span><span class="s2">(</span><span class="s0">n_clusters</span><span class="s2">=</span><span class="s5">5</span><span class="s2">, </span><span class="s0">random_state</span><span class="s2">=</span><span class="s5">42</span><span class="s2">, </span><span class="s0">n_init</span><span class="s2">=</span><span class="s4">'auto'</span><span class="s2">)</span>
    <span class="s0">rfm</span><span class="s2">[</span><span class="s4">'Cluster'</span><span class="s2">] = </span><span class="s0">kmeans</span><span class="s2">.</span><span class="s0">fit_predict</span><span class="s2">(</span><span class="s0">rfm_pca</span><span class="s2">)</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Assigned cluster labels to RFM data.</span><span class="s1">\n</span><span class="s4">&quot;</span><span class="s2">, </span><span class="s0">rfm</span><span class="s2">[[</span><span class="s4">'CustomerID'</span><span class="s2">, </span><span class="s4">'Cluster'</span><span class="s2">]].</span><span class="s0">head</span><span class="s2">())</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s0">rfm</span><span class="s2">[</span><span class="s4">'Cluster'</span><span class="s2">].</span><span class="s0">value_counts</span><span class="s2">())</span>

    <span class="s3">############################################################</span>
    <span class="s3"># 8. VISUALIZE CLUSTERS</span>
    <span class="s3">############################################################</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">figure</span><span class="s2">(</span><span class="s0">figsize</span><span class="s2">=(</span><span class="s5">8</span><span class="s2">, </span><span class="s5">6</span><span class="s2">))</span>
    <span class="s0">sns</span><span class="s2">.</span><span class="s0">scatterplot</span><span class="s2">(</span><span class="s0">x</span><span class="s2">=</span><span class="s0">rfm_pca</span><span class="s2">[:, </span><span class="s5">0</span><span class="s2">], </span><span class="s0">y</span><span class="s2">=</span><span class="s0">rfm_pca</span><span class="s2">[:, </span><span class="s5">1</span><span class="s2">],</span>
                    <span class="s0">hue</span><span class="s2">=</span><span class="s0">rfm</span><span class="s2">[</span><span class="s4">'Cluster'</span><span class="s2">], </span><span class="s0">palette</span><span class="s2">=</span><span class="s4">'viridis'</span><span class="s2">, </span><span class="s0">s</span><span class="s2">=</span><span class="s5">100</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">title</span><span class="s2">(</span><span class="s4">&quot;Customer Segmentation (PCA=2) - 5 Clusters&quot;</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">xlabel</span><span class="s2">(</span><span class="s4">&quot;PCA Component 1&quot;</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">ylabel</span><span class="s2">(</span><span class="s4">&quot;PCA Component 2&quot;</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">grid</span><span class="s2">()</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">show</span><span class="s2">()</span>

    <span class="s3">############################################################</span>
    <span class="s3"># 9. CLUSTER SUMMARY</span>
    <span class="s3">############################################################</span>
    <span class="s0">agg_dict </span><span class="s2">= {</span>
        <span class="s4">'Recency'</span><span class="s2">: </span><span class="s4">'mean'</span><span class="s2">,</span>
        <span class="s4">'Frequency'</span><span class="s2">: </span><span class="s4">'mean'</span><span class="s2">,</span>
        <span class="s4">'ReturnRate'</span><span class="s2">: </span><span class="s4">'mean'</span><span class="s2">,</span>
        <span class="s4">'CLV'</span><span class="s2">: </span><span class="s4">'mean'</span><span class="s2">,</span>
        <span class="s4">'AvgOrderValue'</span><span class="s2">: </span><span class="s4">'mean'</span><span class="s2">,</span>
        <span class="s4">'LoyaltyScore'</span><span class="s2">: </span><span class="s4">'mean'</span>
    <span class="s2">}</span>
    <span class="s1">for </span><span class="s0">col </span><span class="s1">in </span><span class="s0">categorical_features</span><span class="s2">:</span>
        <span class="s0">agg_dict</span><span class="s2">[</span><span class="s0">col</span><span class="s2">] = </span><span class="s4">'sum'</span>

    <span class="s0">cluster_summary </span><span class="s2">= </span><span class="s0">rfm</span><span class="s2">.</span><span class="s0">groupby</span><span class="s2">(</span><span class="s4">'Cluster'</span><span class="s2">).</span><span class="s0">agg</span><span class="s2">(</span><span class="s0">agg_dict</span><span class="s2">).</span><span class="s0">reset_index</span><span class="s2">()</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Cluster Summary:</span><span class="s1">\n</span><span class="s4">&quot;</span><span class="s2">, </span><span class="s0">cluster_summary</span><span class="s2">)</span>

    <span class="s0">rfm</span><span class="s2">.</span><span class="s0">to_csv</span><span class="s2">(</span><span class="s4">&quot;rfm_segmented_with_month.csv&quot;</span><span class="s2">, </span><span class="s0">index</span><span class="s2">=</span><span class="s1">False</span><span class="s2">)</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Segmented data saved to rfm_segmented_with_month.csv&quot;</span><span class="s2">)</span>


    <span class="s3">############################################################</span>
    <span class="s3"># 10. PRODUCT DATA (PRICE &amp; POPULARITY) + RECOMMENDATION</span>
    <span class="s3">############################################################</span>
    <span class="s1">def </span><span class="s0">extract_category_brand</span><span class="s2">(</span><span class="s0">description</span><span class="s2">):</span>
        <span class="s0">desc </span><span class="s2">= </span><span class="s0">description</span><span class="s2">.</span><span class="s0">upper</span><span class="s2">()</span>
        <span class="s1">if </span><span class="s4">'RETROSPOT' </span><span class="s1">in </span><span class="s0">desc</span><span class="s2">:</span>
            <span class="s0">brand </span><span class="s2">= </span><span class="s4">'Retrospot'</span>
        <span class="s1">elif </span><span class="s4">'PANTRY' </span><span class="s1">in </span><span class="s0">desc</span><span class="s2">:</span>
            <span class="s0">brand </span><span class="s2">= </span><span class="s4">'Pantry'</span>
        <span class="s1">elif </span><span class="s4">'REGENCY' </span><span class="s1">in </span><span class="s0">desc</span><span class="s2">:</span>
            <span class="s0">brand </span><span class="s2">= </span><span class="s4">'Regency'</span>
        <span class="s1">elif </span><span class="s4">'SKULL' </span><span class="s1">in </span><span class="s0">desc</span><span class="s2">:</span>
            <span class="s0">brand </span><span class="s2">= </span><span class="s4">'Skull'</span>
        <span class="s1">elif </span><span class="s4">'GARDEN' </span><span class="s1">in </span><span class="s0">desc</span><span class="s2">:</span>
            <span class="s0">brand </span><span class="s2">= </span><span class="s4">'Garden'</span>
        <span class="s1">else</span><span class="s2">:</span>
            <span class="s0">brand </span><span class="s2">= </span><span class="s4">'GenericBrand'</span>

        <span class="s1">if </span><span class="s4">'LUNCH BAG' </span><span class="s1">in </span><span class="s0">desc</span><span class="s2">:</span>
            <span class="s0">category </span><span class="s2">= </span><span class="s4">'Bag'</span>
        <span class="s1">elif </span><span class="s4">'HEART' </span><span class="s1">in </span><span class="s0">desc </span><span class="s1">or </span><span class="s4">'LOVE' </span><span class="s1">in </span><span class="s0">desc</span><span class="s2">:</span>
            <span class="s0">category </span><span class="s2">= </span><span class="s4">'HeartDecoration'</span>
        <span class="s1">elif </span><span class="s4">'BUNTING' </span><span class="s1">in </span><span class="s0">desc </span><span class="s1">or </span><span class="s4">'PARTY' </span><span class="s1">in </span><span class="s0">desc </span><span class="s1">or </span><span class="s4">'CELEBRATION' </span><span class="s1">in </span><span class="s0">desc</span><span class="s2">:</span>
            <span class="s0">category </span><span class="s2">= </span><span class="s4">'PartyDecor'</span>
        <span class="s1">elif </span><span class="s0">any</span><span class="s2">(</span><span class="s0">kw </span><span class="s1">in </span><span class="s0">desc </span><span class="s1">for </span><span class="s0">kw </span><span class="s1">in</span>
                 <span class="s2">[</span><span class="s4">'JAM MAKING'</span><span class="s2">, </span><span class="s4">'TEA SET'</span><span class="s2">, </span><span class="s4">'CAKE TINS'</span><span class="s2">, </span><span class="s4">'BAKING SET'</span><span class="s2">, </span><span class="s4">'RECIPE BOX'</span><span class="s2">, </span><span class="s4">'BAKE'</span><span class="s2">, </span><span class="s4">'KITCHEN'</span><span class="s2">]):</span>
            <span class="s0">category </span><span class="s2">= </span><span class="s4">'Kitchen'</span>
        <span class="s1">elif </span><span class="s4">'PAPER CHAIN' </span><span class="s1">in </span><span class="s0">desc </span><span class="s1">or </span><span class="s4">'CRAFT' </span><span class="s1">in </span><span class="s0">desc</span><span class="s2">:</span>
            <span class="s0">category </span><span class="s2">= </span><span class="s4">'Party'</span>
        <span class="s1">elif </span><span class="s0">any</span><span class="s2">(</span><span class="s0">kw </span><span class="s1">in </span><span class="s0">desc </span><span class="s1">for </span><span class="s0">kw </span><span class="s1">in </span><span class="s2">[</span><span class="s4">'ALARM CLOCK'</span><span class="s2">, </span><span class="s4">'CLOCK'</span><span class="s2">, </span><span class="s4">'TIME'</span><span class="s2">]):</span>
            <span class="s0">category </span><span class="s2">= </span><span class="s4">'Home'</span>
        <span class="s1">elif </span><span class="s0">any</span><span class="s2">(</span><span class="s0">kw </span><span class="s1">in </span><span class="s0">desc </span><span class="s1">for </span><span class="s0">kw </span><span class="s1">in </span><span class="s2">[</span><span class="s4">'FRAME'</span><span class="s2">, </span><span class="s4">'PICTURE'</span><span class="s2">, </span><span class="s4">'PHOTO'</span><span class="s2">]):</span>
            <span class="s0">category </span><span class="s2">= </span><span class="s4">'Decor'</span>
        <span class="s1">elif </span><span class="s0">any</span><span class="s2">(</span><span class="s0">kw </span><span class="s1">in </span><span class="s0">desc </span><span class="s1">for </span><span class="s0">kw </span><span class="s1">in </span><span class="s2">[</span><span class="s4">'TOY'</span><span class="s2">, </span><span class="s4">'CHILD'</span><span class="s2">, </span><span class="s4">'KIDS'</span><span class="s2">]):</span>
            <span class="s0">category </span><span class="s2">= </span><span class="s4">'Toys'</span>
        <span class="s1">elif </span><span class="s0">any</span><span class="s2">(</span><span class="s0">kw </span><span class="s1">in </span><span class="s0">desc </span><span class="s1">for </span><span class="s0">kw </span><span class="s1">in </span><span class="s2">[</span><span class="s4">'GARDEN'</span><span class="s2">, </span><span class="s4">'OUTDOOR'</span><span class="s2">]):</span>
            <span class="s0">category </span><span class="s2">= </span><span class="s4">'Garden'</span>
        <span class="s1">elif </span><span class="s0">any</span><span class="s2">(</span><span class="s0">kw </span><span class="s1">in </span><span class="s0">desc </span><span class="s1">for </span><span class="s0">kw </span><span class="s1">in </span><span class="s2">[</span><span class="s4">'CHRISTMAS'</span><span class="s2">, </span><span class="s4">'HOLIDAY'</span><span class="s2">]):</span>
            <span class="s0">category </span><span class="s2">= </span><span class="s4">'Seasonal'</span>
        <span class="s1">else</span><span class="s2">:</span>
            <span class="s0">category </span><span class="s2">= </span><span class="s4">'Other'</span>
        <span class="s1">return </span><span class="s0">category</span><span class="s2">, </span><span class="s0">brand</span>


    <span class="s0">product_info </span><span class="s2">= </span><span class="s0">df</span><span class="s2">[[</span><span class="s4">'StockCode'</span><span class="s2">, </span><span class="s4">'Description'</span><span class="s2">, </span><span class="s4">'UnitPrice'</span><span class="s2">, </span><span class="s4">'Quantity'</span><span class="s2">]].</span><span class="s0">copy</span><span class="s2">()</span>
    <span class="s0">product_info</span><span class="s2">.</span><span class="s0">rename</span><span class="s2">(</span><span class="s0">columns</span><span class="s2">={</span><span class="s4">'StockCode'</span><span class="s2">: </span><span class="s4">'ProductID'</span><span class="s2">}, </span><span class="s0">inplace</span><span class="s2">=</span><span class="s1">True</span><span class="s2">)</span>
    <span class="s0">product_info</span><span class="s2">.</span><span class="s0">dropna</span><span class="s2">(</span><span class="s0">subset</span><span class="s2">=[</span><span class="s4">'Description'</span><span class="s2">], </span><span class="s0">inplace</span><span class="s2">=</span><span class="s1">True</span><span class="s2">)</span>

    <span class="s0">product_stats </span><span class="s2">= </span><span class="s0">product_info</span><span class="s2">.</span><span class="s0">groupby</span><span class="s2">(</span><span class="s4">'ProductID'</span><span class="s2">).</span><span class="s0">agg</span><span class="s2">({</span>
        <span class="s4">'UnitPrice'</span><span class="s2">: </span><span class="s4">'mean'</span><span class="s2">,</span>
        <span class="s4">'Quantity'</span><span class="s2">: </span><span class="s4">'sum'</span><span class="s2">,</span>
        <span class="s4">'Description'</span><span class="s2">: </span><span class="s4">'first'</span>
    <span class="s2">}).</span><span class="s0">reset_index</span><span class="s2">()</span>

    <span class="s0">product_stats</span><span class="s2">[[</span><span class="s4">'Category'</span><span class="s2">, </span><span class="s4">'Brand'</span><span class="s2">]] = </span><span class="s0">product_stats</span><span class="s2">[</span><span class="s4">'Description'</span><span class="s2">].</span><span class="s0">apply</span><span class="s2">(</span>
        <span class="s1">lambda </span><span class="s0">x</span><span class="s2">: </span><span class="s0">pd</span><span class="s2">.</span><span class="s0">Series</span><span class="s2">(</span><span class="s0">extract_category_brand</span><span class="s2">(</span><span class="s0">x</span><span class="s2">))</span>
    <span class="s2">)</span>
    <span class="s0">product_stats</span><span class="s2">.</span><span class="s0">rename</span><span class="s2">(</span><span class="s0">columns</span><span class="s2">={</span><span class="s4">'UnitPrice'</span><span class="s2">: </span><span class="s4">'Price'</span><span class="s2">, </span><span class="s4">'Quantity'</span><span class="s2">: </span><span class="s4">'Popularity'</span><span class="s2">}, </span><span class="s0">inplace</span><span class="s2">=</span><span class="s1">True</span><span class="s2">)</span>
    <span class="s0">product_stats</span><span class="s2">.</span><span class="s0">to_csv</span><span class="s2">(</span><span class="s4">&quot;product_metadata.csv&quot;</span><span class="s2">, </span><span class="s0">index</span><span class="s2">=</span><span class="s1">False</span><span class="s2">)</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Created product_metadata.csv from actual descriptions with real Price &amp; Popularity.&quot;</span><span class="s2">)</span>

    <span class="s0">product_data </span><span class="s2">= </span><span class="s0">pd</span><span class="s2">.</span><span class="s0">read_csv</span><span class="s2">(</span><span class="s4">&quot;product_metadata.csv&quot;</span><span class="s2">)</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Loaded product_metadata.csv. Columns:&quot;</span><span class="s2">, </span><span class="s0">product_data</span><span class="s2">.</span><span class="s0">columns</span><span class="s2">)</span>

    <span class="s1">if not </span><span class="s2">{</span><span class="s4">'ProductID'</span><span class="s2">, </span><span class="s4">'Price'</span><span class="s2">, </span><span class="s4">'Popularity'</span><span class="s2">, </span><span class="s4">'Category'</span><span class="s2">, </span><span class="s4">'Brand'</span><span class="s2">}.</span><span class="s0">issubset</span><span class="s2">(</span><span class="s0">product_data</span><span class="s2">.</span><span class="s0">columns</span><span class="s2">):</span>
        <span class="s1">raise </span><span class="s0">ValueError</span><span class="s2">(</span><span class="s4">&quot;product_metadata must have ProductID, Price, Popularity, Category, Brand columns.&quot;</span><span class="s2">)</span>

    <span class="s0">product_data</span><span class="s2">.</span><span class="s0">drop_duplicates</span><span class="s2">(</span><span class="s0">subset</span><span class="s2">=[</span><span class="s4">'ProductID'</span><span class="s2">], </span><span class="s0">inplace</span><span class="s2">=</span><span class="s1">True</span><span class="s2">)</span>
    <span class="s0">product_data</span><span class="s2">[</span><span class="s4">'Price'</span><span class="s2">] = </span><span class="s0">pd</span><span class="s2">.</span><span class="s0">to_numeric</span><span class="s2">(</span><span class="s0">product_data</span><span class="s2">[</span><span class="s4">'Price'</span><span class="s2">], </span><span class="s0">errors</span><span class="s2">=</span><span class="s4">'coerce'</span><span class="s2">).</span><span class="s0">fillna</span><span class="s2">(</span><span class="s0">product_data</span><span class="s2">[</span><span class="s4">'Price'</span><span class="s2">].</span><span class="s0">mean</span><span class="s2">())</span>
    <span class="s0">product_data</span><span class="s2">[</span><span class="s4">'Popularity'</span><span class="s2">] = </span><span class="s0">pd</span><span class="s2">.</span><span class="s0">to_numeric</span><span class="s2">(</span><span class="s0">product_data</span><span class="s2">[</span><span class="s4">'Popularity'</span><span class="s2">], </span><span class="s0">errors</span><span class="s2">=</span><span class="s4">'coerce'</span><span class="s2">) </span><span class="s0">\</span>
        <span class="s2">.</span><span class="s0">fillna</span><span class="s2">(</span><span class="s0">product_data</span><span class="s2">[</span><span class="s4">'Popularity'</span><span class="s2">].</span><span class="s0">mean</span><span class="s2">())</span>

    <span class="s0">brand_encoder </span><span class="s2">= </span><span class="s0">LabelEncoder</span><span class="s2">()</span>
    <span class="s0">category_encoder </span><span class="s2">= </span><span class="s0">LabelEncoder</span><span class="s2">()</span>
    <span class="s0">product_data</span><span class="s2">[</span><span class="s4">'Brand_enc'</span><span class="s2">] = </span><span class="s0">brand_encoder</span><span class="s2">.</span><span class="s0">fit_transform</span><span class="s2">(</span><span class="s0">product_data</span><span class="s2">[</span><span class="s4">'Brand'</span><span class="s2">])</span>
    <span class="s0">product_data</span><span class="s2">[</span><span class="s4">'Category_enc'</span><span class="s2">] = </span><span class="s0">category_encoder</span><span class="s2">.</span><span class="s0">fit_transform</span><span class="s2">(</span><span class="s0">product_data</span><span class="s2">[</span><span class="s4">'Category'</span><span class="s2">])</span>

    <span class="s0">feature_cols </span><span class="s2">= [</span><span class="s4">'Price'</span><span class="s2">, </span><span class="s4">'Popularity'</span><span class="s2">, </span><span class="s4">'Brand_enc'</span><span class="s2">, </span><span class="s4">'Category_enc'</span><span class="s2">]</span>
    <span class="s0">scaler_product </span><span class="s2">= </span><span class="s0">StandardScaler</span><span class="s2">()</span>
    <span class="s0">product_data</span><span class="s2">[</span><span class="s0">feature_cols</span><span class="s2">] = </span><span class="s0">scaler_product</span><span class="s2">.</span><span class="s0">fit_transform</span><span class="s2">(</span><span class="s0">product_data</span><span class="s2">[</span><span class="s0">feature_cols</span><span class="s2">])</span>

    <span class="s0">product_similarity </span><span class="s2">= </span><span class="s0">cosine_similarity</span><span class="s2">(</span><span class="s0">product_data</span><span class="s2">[</span><span class="s0">feature_cols</span><span class="s2">])</span>
    <span class="s0">product_similarity_df </span><span class="s2">= </span><span class="s0">pd</span><span class="s2">.</span><span class="s0">DataFrame</span><span class="s2">(</span><span class="s0">product_similarity</span><span class="s2">,</span>
                                         <span class="s0">index</span><span class="s2">=</span><span class="s0">product_data</span><span class="s2">[</span><span class="s4">'ProductID'</span><span class="s2">],</span>
                                         <span class="s0">columns</span><span class="s2">=</span><span class="s0">product_data</span><span class="s2">[</span><span class="s4">'ProductID'</span><span class="s2">])</span>


    <span class="s3">############################################################</span>
    <span class="s3"># Intersection Approach in recommend_products</span>
    <span class="s3">############################################################</span>
    <span class="s1">def </span><span class="s0">recommend_products</span><span class="s2">(</span><span class="s0">customer_id</span><span class="s2">, </span><span class="s0">user_item_mat</span><span class="s2">, </span><span class="s0">cust_sim_df</span><span class="s2">, </span><span class="s0">top_n</span><span class="s2">=</span><span class="s5">5</span><span class="s2">):</span>
        <span class="s1">if </span><span class="s0">customer_id </span><span class="s1">not in </span><span class="s0">cust_sim_df</span><span class="s2">.</span><span class="s0">index</span><span class="s2">:</span>
            <span class="s0">print</span><span class="s2">(</span><span class="s4">f&quot;Customer </span><span class="s1">{</span><span class="s0">customer_id</span><span class="s1">} </span><span class="s4">not in similarity index.&quot;</span><span class="s2">)</span>
            <span class="s1">return </span><span class="s2">[]</span>
        <span class="s0">sim_scores </span><span class="s2">= </span><span class="s0">cust_sim_df</span><span class="s2">.</span><span class="s0">loc</span><span class="s2">[</span><span class="s0">customer_id</span><span class="s2">].</span><span class="s0">drop</span><span class="s2">(</span><span class="s0">customer_id</span><span class="s2">, </span><span class="s0">errors</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">)</span>

        <span class="s3"># Intersection -&gt; dimension mismatch çözümü</span>
        <span class="s0">common_customers </span><span class="s2">= </span><span class="s0">sim_scores</span><span class="s2">.</span><span class="s0">index</span><span class="s2">.</span><span class="s0">intersection</span><span class="s2">(</span><span class="s0">user_item_mat</span><span class="s2">.</span><span class="s0">index</span><span class="s2">)</span>
        <span class="s1">if </span><span class="s0">len</span><span class="s2">(</span><span class="s0">common_customers</span><span class="s2">) == </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;No common customers found. Possibly dimension mismatch.&quot;</span><span class="s2">)</span>
            <span class="s1">return </span><span class="s2">[]</span>

        <span class="s0">sim_scores_sub </span><span class="s2">= </span><span class="s0">sim_scores</span><span class="s2">.</span><span class="s0">loc</span><span class="s2">[</span><span class="s0">common_customers</span><span class="s2">].</span><span class="s0">sort_index</span><span class="s2">()</span>
        <span class="s0">user_item_sub </span><span class="s2">= </span><span class="s0">user_item_mat</span><span class="s2">.</span><span class="s0">loc</span><span class="s2">[</span><span class="s0">common_customers</span><span class="s2">].</span><span class="s0">sort_index</span><span class="s2">()</span>

        <span class="s0">weighted_purchases </span><span class="s2">= </span><span class="s0">user_item_sub</span><span class="s2">.</span><span class="s0">multiply</span><span class="s2">(</span><span class="s0">sim_scores_sub</span><span class="s2">, </span><span class="s0">axis</span><span class="s2">=</span><span class="s4">'index'</span><span class="s2">).</span><span class="s0">sum</span><span class="s2">(</span><span class="s0">axis</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>

        <span class="s1">if </span><span class="s0">customer_id </span><span class="s1">not in </span><span class="s0">user_item_mat</span><span class="s2">.</span><span class="s0">index</span><span class="s2">:</span>
            <span class="s0">print</span><span class="s2">(</span><span class="s4">f&quot;Customer </span><span class="s1">{</span><span class="s0">customer_id</span><span class="s1">} </span><span class="s4">not in user_item_mat index.&quot;</span><span class="s2">)</span>
            <span class="s1">return </span><span class="s2">[]</span>
        <span class="s0">already_purchased </span><span class="s2">= </span><span class="s0">user_item_mat</span><span class="s2">.</span><span class="s0">loc</span><span class="s2">[</span><span class="s0">customer_id</span><span class="s2">] &gt; </span><span class="s5">0</span>
        <span class="s0">candidates </span><span class="s2">= </span><span class="s0">weighted_purchases</span><span class="s2">[~</span><span class="s0">already_purchased</span><span class="s2">]</span>

        <span class="s1">return </span><span class="s0">candidates</span><span class="s2">.</span><span class="s0">sort_values</span><span class="s2">(</span><span class="s0">ascending</span><span class="s2">=</span><span class="s1">False</span><span class="s2">).</span><span class="s0">head</span><span class="s2">(</span><span class="s0">top_n</span><span class="s2">).</span><span class="s0">index</span><span class="s2">.</span><span class="s0">tolist</span><span class="s2">()</span>


    <span class="s1">def </span><span class="s0">recommend_similar_products</span><span class="s2">(</span><span class="s0">product_id</span><span class="s2">, </span><span class="s0">product_sim_df</span><span class="s2">, </span><span class="s0">top_n</span><span class="s2">=</span><span class="s5">5</span><span class="s2">):</span>
        <span class="s1">if </span><span class="s0">product_id </span><span class="s1">not in </span><span class="s0">product_sim_df</span><span class="s2">.</span><span class="s0">index</span><span class="s2">:</span>
            <span class="s0">print</span><span class="s2">(</span><span class="s4">f&quot;Product </span><span class="s1">{</span><span class="s0">product_id</span><span class="s1">} </span><span class="s4">not in similarity index.&quot;</span><span class="s2">)</span>
            <span class="s1">return </span><span class="s2">[]</span>
        <span class="s0">similar_scores </span><span class="s2">= </span><span class="s0">product_sim_df</span><span class="s2">.</span><span class="s0">loc</span><span class="s2">[</span><span class="s0">product_id</span><span class="s2">].</span><span class="s0">sort_values</span><span class="s2">(</span><span class="s0">ascending</span><span class="s2">=</span><span class="s1">False</span><span class="s2">)</span>
        <span class="s1">return </span><span class="s0">similar_scores</span><span class="s2">.</span><span class="s0">iloc</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:</span><span class="s0">top_n </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">].</span><span class="s0">index</span><span class="s2">.</span><span class="s0">tolist</span><span class="s2">()</span>


    <span class="s3"># user_item_matrix, customer_similarity</span>
    <span class="s0">user_item_matrix </span><span class="s2">= </span><span class="s0">purchase_data</span><span class="s2">.</span><span class="s0">pivot_table</span><span class="s2">(</span><span class="s0">index</span><span class="s2">=</span><span class="s4">'CustomerID'</span><span class="s2">,</span>
                                                 <span class="s0">columns</span><span class="s2">=</span><span class="s4">'ProductID'</span><span class="s2">,</span>
                                                 <span class="s0">values</span><span class="s2">=</span><span class="s4">'PurchaseAmount'</span><span class="s2">,</span>
                                                 <span class="s0">fill_value</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s0">customer_similarity </span><span class="s2">= </span><span class="s0">cosine_similarity</span><span class="s2">(</span><span class="s0">user_item_matrix</span><span class="s2">)</span>
    <span class="s0">customer_similarity_df </span><span class="s2">= </span><span class="s0">pd</span><span class="s2">.</span><span class="s0">DataFrame</span><span class="s2">(</span><span class="s0">customer_similarity</span><span class="s2">,</span>
                                          <span class="s0">index</span><span class="s2">=</span><span class="s0">user_item_matrix</span><span class="s2">.</span><span class="s0">index</span><span class="s2">,</span>
                                          <span class="s0">columns</span><span class="s2">=</span><span class="s0">user_item_matrix</span><span class="s2">.</span><span class="s0">index</span><span class="s2">)</span>

    <span class="s3"># Test: Collab Filtering</span>
    <span class="s1">if not </span><span class="s0">purchase_data</span><span class="s2">.</span><span class="s0">empty</span><span class="s2">:</span>
        <span class="s0">sample_customer_id </span><span class="s2">= </span><span class="s0">user_item_matrix</span><span class="s2">.</span><span class="s0">index</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s0">print</span><span class="s2">(</span><span class="s4">f&quot;</span><span class="s1">\n</span><span class="s4">Getting recommendations for Customer </span><span class="s1">{</span><span class="s0">sample_customer_id</span><span class="s1">} </span><span class="s4">using Collaborative Filtering...&quot;</span><span class="s2">)</span>
        <span class="s0">recs </span><span class="s2">= </span><span class="s0">recommend_products</span><span class="s2">(</span><span class="s0">sample_customer_id</span><span class="s2">, </span><span class="s0">user_item_matrix</span><span class="s2">, </span><span class="s0">customer_similarity_df</span><span class="s2">)</span>
        <span class="s0">print</span><span class="s2">(</span><span class="s4">f&quot;Recommended Products for Customer </span><span class="s1">{</span><span class="s0">sample_customer_id</span><span class="s1">}</span><span class="s4">: </span><span class="s1">{</span><span class="s0">recs</span><span class="s1">}</span><span class="s4">&quot;</span><span class="s2">)</span>

        <span class="s0">recommended_details </span><span class="s2">= </span><span class="s0">product_data</span><span class="s2">[</span><span class="s0">product_data</span><span class="s2">[</span><span class="s4">'ProductID'</span><span class="s2">].</span><span class="s0">isin</span><span class="s2">(</span><span class="s0">recs</span><span class="s2">)][</span>
            <span class="s2">[</span><span class="s4">'ProductID'</span><span class="s2">, </span><span class="s4">'Description'</span><span class="s2">, </span><span class="s4">'Category'</span><span class="s2">, </span><span class="s4">'Brand'</span><span class="s2">]</span>
        <span class="s2">]</span>
        <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;</span><span class="s1">\n</span><span class="s4">Recommended Products Details (with Category &amp; Brand):&quot;</span><span class="s2">)</span>
        <span class="s0">print</span><span class="s2">(</span><span class="s0">recommended_details</span><span class="s2">)</span>

    <span class="s3"># Test: Content-Based</span>
    <span class="s0">test_product_id </span><span class="s2">= </span><span class="s0">product_data</span><span class="s2">[</span><span class="s4">'ProductID'</span><span class="s2">].</span><span class="s0">iloc</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">f&quot;</span><span class="s1">\n</span><span class="s4">Getting similar products for Product </span><span class="s1">{</span><span class="s0">test_product_id</span><span class="s1">} </span><span class="s4">using Content-Based Filtering...&quot;</span><span class="s2">)</span>
    <span class="s0">sim_products </span><span class="s2">= </span><span class="s0">recommend_similar_products</span><span class="s2">(</span><span class="s0">test_product_id</span><span class="s2">, </span><span class="s0">product_similarity_df</span><span class="s2">)</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">f&quot;Products Similar to Product </span><span class="s1">{</span><span class="s0">test_product_id</span><span class="s1">}</span><span class="s4">: </span><span class="s1">{</span><span class="s0">sim_products</span><span class="s1">}</span><span class="s4">&quot;</span><span class="s2">)</span>

    <span class="s0">similar_details </span><span class="s2">= </span><span class="s0">product_data</span><span class="s2">[</span><span class="s0">product_data</span><span class="s2">[</span><span class="s4">'ProductID'</span><span class="s2">].</span><span class="s0">isin</span><span class="s2">(</span><span class="s0">sim_products</span><span class="s2">)][</span>
        <span class="s2">[</span><span class="s4">'ProductID'</span><span class="s2">, </span><span class="s4">'Description'</span><span class="s2">, </span><span class="s4">'Category'</span><span class="s2">, </span><span class="s4">'Brand'</span><span class="s2">]</span>
    <span class="s2">]</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;</span><span class="s1">\n</span><span class="s4">Similar Products Details (with Category &amp; Brand):&quot;</span><span class="s2">)</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s0">similar_details</span><span class="s2">)</span>

    <span class="s3">############################################################</span>
    <span class="s3"># 11. PREDICTIVE MODELING FOR AvgOrderValue</span>
    <span class="s3">############################################################</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;</span><span class="s1">\n</span><span class="s4">Building a predictive model for AvgOrderValue with GradientBoosting...&quot;</span><span class="s2">)</span>

    <span class="s3"># Monetary'i çıkararak collinearity azalttığımız için,</span>
    <span class="s3"># regression'da da Monetary olmadan ilerliyoruz (isteğe bağlı).</span>
    <span class="s0">X </span><span class="s2">= </span><span class="s0">rfm</span><span class="s2">[[</span><span class="s4">'Recency'</span><span class="s2">, </span><span class="s4">'Frequency'</span><span class="s2">, </span><span class="s4">'ReturnRate'</span><span class="s2">, </span><span class="s4">'CLV'</span><span class="s2">, </span><span class="s4">'LoyaltyScore'</span><span class="s2">, </span><span class="s4">'AvgOrderValue'</span><span class="s2">]]</span>
    <span class="s0">y </span><span class="s2">= </span><span class="s0">rfm</span><span class="s2">[</span><span class="s4">'AvgOrderValue'</span><span class="s2">]</span>

    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Features (X):&quot;</span><span class="s2">, </span><span class="s0">X</span><span class="s2">.</span><span class="s0">head</span><span class="s2">())</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Target (y):&quot;</span><span class="s2">, </span><span class="s0">y</span><span class="s2">.</span><span class="s0">head</span><span class="s2">())</span>

    <span class="s0">X_train</span><span class="s2">, </span><span class="s0">X_test</span><span class="s2">, </span><span class="s0">y_train</span><span class="s2">, </span><span class="s0">y_test </span><span class="s2">= </span><span class="s0">train_test_split</span><span class="s2">(</span><span class="s0">X</span><span class="s2">, </span><span class="s0">y</span><span class="s2">, </span><span class="s0">test_size</span><span class="s2">=</span><span class="s5">0.2</span><span class="s2">, </span><span class="s0">random_state</span><span class="s2">=</span><span class="s5">42</span><span class="s2">)</span>

    <span class="s0">gbr </span><span class="s2">= </span><span class="s0">GradientBoostingRegressor</span><span class="s2">(</span><span class="s0">random_state</span><span class="s2">=</span><span class="s5">42</span><span class="s2">)</span>
    <span class="s0">param_grid </span><span class="s2">= {</span>
        <span class="s4">'n_estimators'</span><span class="s2">: [</span><span class="s5">100</span><span class="s2">, </span><span class="s5">200</span><span class="s2">],</span>
        <span class="s4">'max_depth'</span><span class="s2">: [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">7</span><span class="s2">],</span>
        <span class="s4">'learning_rate'</span><span class="s2">: [</span><span class="s5">0.05</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">],</span>
        <span class="s4">'min_samples_split'</span><span class="s2">: [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">]</span>
    <span class="s2">}</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Performing grid search for GradientBoosting parameters...&quot;</span><span class="s2">)</span>
    <span class="s0">grid </span><span class="s2">= </span><span class="s0">GridSearchCV</span><span class="s2">(</span><span class="s0">gbr</span><span class="s2">, </span><span class="s0">param_grid</span><span class="s2">, </span><span class="s0">cv</span><span class="s2">=</span><span class="s5">5</span><span class="s2">, </span><span class="s0">scoring</span><span class="s2">=</span><span class="s4">'neg_mean_squared_error'</span><span class="s2">, </span><span class="s0">n_jobs</span><span class="s2">=-</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s0">grid</span><span class="s2">.</span><span class="s0">fit</span><span class="s2">(</span><span class="s0">X_train</span><span class="s2">, </span><span class="s0">y_train</span><span class="s2">)</span>

    <span class="s0">best_gbr </span><span class="s2">= </span><span class="s0">grid</span><span class="s2">.</span><span class="s0">best_estimator_</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Best parameters for GradientBoosting:&quot;</span><span class="s2">, </span><span class="s0">grid</span><span class="s2">.</span><span class="s0">best_params_</span><span class="s2">)</span>

    <span class="s0">y_pred </span><span class="s2">= </span><span class="s0">best_gbr</span><span class="s2">.</span><span class="s0">predict</span><span class="s2">(</span><span class="s0">X_test</span><span class="s2">)</span>
    <span class="s0">rmse </span><span class="s2">= </span><span class="s0">np</span><span class="s2">.</span><span class="s0">sqrt</span><span class="s2">(</span><span class="s0">mean_squared_error</span><span class="s2">(</span><span class="s0">y_test</span><span class="s2">, </span><span class="s0">y_pred</span><span class="s2">))</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">f&quot;GradientBoosting RMSE on test set: </span><span class="s1">{</span><span class="s0">rmse</span><span class="s1">:</span><span class="s4">.2f</span><span class="s1">}</span><span class="s4">&quot;</span><span class="s2">)</span>

    <span class="s0">feat_importances </span><span class="s2">= </span><span class="s0">pd</span><span class="s2">.</span><span class="s0">Series</span><span class="s2">(</span><span class="s0">best_gbr</span><span class="s2">.</span><span class="s0">feature_importances_</span><span class="s2">, </span><span class="s0">index</span><span class="s2">=</span><span class="s0">X</span><span class="s2">.</span><span class="s0">columns</span><span class="s2">).</span><span class="s0">sort_values</span><span class="s2">(</span><span class="s0">ascending</span><span class="s2">=</span><span class="s1">False</span><span class="s2">)</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;Feature Importances:</span><span class="s1">\n</span><span class="s4">&quot;</span><span class="s2">, </span><span class="s0">feat_importances</span><span class="s2">)</span>

    <span class="s3">############################################################</span>
    <span class="s3"># 12. TIME SERIES FORECASTING (PROPHET)</span>
    <span class="s3">############################################################</span>
    <span class="s4">&quot;&quot;&quot; 
    ADIM 12: 
    - Prophet ile günlük satışları tahmin 
    - Son 6 ay test, RMSE 
    - Sonra tüm veriye fit -&gt; gelecek 6 ay projeksiyon 
    &quot;&quot;&quot;</span>
    <span class="s0">df_time </span><span class="s2">= </span><span class="s0">df</span><span class="s2">.</span><span class="s0">copy</span><span class="s2">()</span>
    <span class="s0">df_time</span><span class="s2">[</span><span class="s4">'InvoiceDate'</span><span class="s2">] = </span><span class="s0">pd</span><span class="s2">.</span><span class="s0">to_datetime</span><span class="s2">(</span><span class="s0">df_time</span><span class="s2">[</span><span class="s4">'InvoiceDate'</span><span class="s2">]).</span><span class="s0">dt</span><span class="s2">.</span><span class="s0">date</span>
    <span class="s0">daily_sales </span><span class="s2">= </span><span class="s0">df_time</span><span class="s2">.</span><span class="s0">groupby</span><span class="s2">(</span><span class="s4">'InvoiceDate'</span><span class="s2">)[</span><span class="s4">'TotalPrice'</span><span class="s2">].</span><span class="s0">sum</span><span class="s2">().</span><span class="s0">reset_index</span><span class="s2">()</span>
    <span class="s0">daily_sales</span><span class="s2">.</span><span class="s0">columns </span><span class="s2">= [</span><span class="s4">'ds'</span><span class="s2">, </span><span class="s4">'y'</span><span class="s2">]</span>

    <span class="s0">cutoff_date </span><span class="s2">= </span><span class="s0">pd</span><span class="s2">.</span><span class="s0">to_datetime</span><span class="s2">(</span><span class="s0">daily_sales</span><span class="s2">[</span><span class="s4">'ds'</span><span class="s2">].</span><span class="s0">max</span><span class="s2">()) - </span><span class="s0">pd</span><span class="s2">.</span><span class="s0">Timedelta</span><span class="s2">(</span><span class="s0">days</span><span class="s2">=</span><span class="s5">180</span><span class="s2">)</span>
    <span class="s0">train_data </span><span class="s2">= </span><span class="s0">daily_sales</span><span class="s2">[</span><span class="s0">daily_sales</span><span class="s2">[</span><span class="s4">'ds'</span><span class="s2">] &lt;= </span><span class="s0">cutoff_date</span><span class="s2">.</span><span class="s0">date</span><span class="s2">()]</span>
    <span class="s0">test_data </span><span class="s2">= </span><span class="s0">daily_sales</span><span class="s2">[</span><span class="s0">daily_sales</span><span class="s2">[</span><span class="s4">'ds'</span><span class="s2">] &gt; </span><span class="s0">cutoff_date</span><span class="s2">.</span><span class="s0">date</span><span class="s2">()]</span>

    <span class="s0">print</span><span class="s2">(</span><span class="s4">f&quot;Train set: </span><span class="s1">{</span><span class="s0">train_data</span><span class="s2">[</span><span class="s4">'ds'</span><span class="s2">].</span><span class="s0">min</span><span class="s2">()</span><span class="s1">} </span><span class="s4">to </span><span class="s1">{</span><span class="s0">train_data</span><span class="s2">[</span><span class="s4">'ds'</span><span class="s2">].</span><span class="s0">max</span><span class="s2">()</span><span class="s1">}</span><span class="s4">&quot;</span><span class="s2">)</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">f&quot;Test set : </span><span class="s1">{</span><span class="s0">test_data</span><span class="s2">[</span><span class="s4">'ds'</span><span class="s2">].</span><span class="s0">min</span><span class="s2">()</span><span class="s1">} </span><span class="s4">to </span><span class="s1">{</span><span class="s0">test_data</span><span class="s2">[</span><span class="s4">'ds'</span><span class="s2">].</span><span class="s0">max</span><span class="s2">()</span><span class="s1">}</span><span class="s4">&quot;</span><span class="s2">)</span>

    <span class="s0">prophet_model </span><span class="s2">= </span><span class="s0">Prophet</span><span class="s2">(</span><span class="s0">seasonality_mode</span><span class="s2">=</span><span class="s4">'multiplicative'</span><span class="s2">, </span><span class="s0">yearly_seasonality</span><span class="s2">=</span><span class="s1">True</span><span class="s2">)</span>
    <span class="s0">prophet_model</span><span class="s2">.</span><span class="s0">fit</span><span class="s2">(</span><span class="s0">train_data</span><span class="s2">)</span>

    <span class="s0">days_to_forecast </span><span class="s2">= (</span><span class="s0">test_data</span><span class="s2">[</span><span class="s4">'ds'</span><span class="s2">].</span><span class="s0">max</span><span class="s2">() - </span><span class="s0">test_data</span><span class="s2">[</span><span class="s4">'ds'</span><span class="s2">].</span><span class="s0">min</span><span class="s2">()).</span><span class="s0">days </span><span class="s2">+ </span><span class="s5">1</span>
    <span class="s0">future_test </span><span class="s2">= </span><span class="s0">prophet_model</span><span class="s2">.</span><span class="s0">make_future_dataframe</span><span class="s2">(</span><span class="s0">periods</span><span class="s2">=</span><span class="s0">days_to_forecast</span><span class="s2">, </span><span class="s0">freq</span><span class="s2">=</span><span class="s4">'D'</span><span class="s2">)</span>
    <span class="s0">forecast_test </span><span class="s2">= </span><span class="s0">prophet_model</span><span class="s2">.</span><span class="s0">predict</span><span class="s2">(</span><span class="s0">future_test</span><span class="s2">)</span>

    <span class="s0">forecast_test_mod </span><span class="s2">= </span><span class="s0">forecast_test</span><span class="s2">[[</span><span class="s4">'ds'</span><span class="s2">, </span><span class="s4">'yhat'</span><span class="s2">]].</span><span class="s0">set_index</span><span class="s2">(</span><span class="s4">'ds'</span><span class="s2">)</span>
    <span class="s0">test_data_mod </span><span class="s2">= </span><span class="s0">test_data</span><span class="s2">.</span><span class="s0">set_index</span><span class="s2">(</span><span class="s4">'ds'</span><span class="s2">)</span>

    <span class="s0">df_merged_ts </span><span class="s2">= </span><span class="s0">test_data_mod</span><span class="s2">.</span><span class="s0">join</span><span class="s2">(</span><span class="s0">forecast_test_mod</span><span class="s2">, </span><span class="s0">how</span><span class="s2">=</span><span class="s4">'inner'</span><span class="s2">)</span>
    <span class="s0">rmse_test_prophet </span><span class="s2">= </span><span class="s0">math</span><span class="s2">.</span><span class="s0">sqrt</span><span class="s2">(</span><span class="s0">mean_squared_error</span><span class="s2">(</span><span class="s0">df_merged_ts</span><span class="s2">[</span><span class="s4">'y'</span><span class="s2">], </span><span class="s0">df_merged_ts</span><span class="s2">[</span><span class="s4">'yhat'</span><span class="s2">]))</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">f&quot;Prophet Test RMSE (last 6 months): </span><span class="s1">{</span><span class="s0">rmse_test_prophet</span><span class="s1">:</span><span class="s4">.2f</span><span class="s1">}</span><span class="s4">&quot;</span><span class="s2">)</span>

    <span class="s0">prophet_final </span><span class="s2">= </span><span class="s0">Prophet</span><span class="s2">(</span><span class="s0">seasonality_mode</span><span class="s2">=</span><span class="s4">'multiplicative'</span><span class="s2">, </span><span class="s0">yearly_seasonality</span><span class="s2">=</span><span class="s1">True</span><span class="s2">)</span>
    <span class="s0">prophet_final</span><span class="s2">.</span><span class="s0">fit</span><span class="s2">(</span><span class="s0">daily_sales</span><span class="s2">)</span>
    <span class="s0">future_6m </span><span class="s2">= </span><span class="s0">prophet_final</span><span class="s2">.</span><span class="s0">make_future_dataframe</span><span class="s2">(</span><span class="s0">periods</span><span class="s2">=</span><span class="s5">180</span><span class="s2">, </span><span class="s0">freq</span><span class="s2">=</span><span class="s4">'D'</span><span class="s2">)</span>
    <span class="s0">forecast_6m </span><span class="s2">= </span><span class="s0">prophet_final</span><span class="s2">.</span><span class="s0">predict</span><span class="s2">(</span><span class="s0">future_6m</span><span class="s2">)</span>

    <span class="s0">prophet_final</span><span class="s2">.</span><span class="s0">plot</span><span class="s2">(</span><span class="s0">forecast_6m</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">title</span><span class="s2">(</span><span class="s4">&quot;Prophet Forecast: Next 6 months of sales&quot;</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">show</span><span class="s2">()</span>

    <span class="s0">forecast_6m</span><span class="s2">[</span><span class="s4">'ds'</span><span class="s2">] = </span><span class="s0">forecast_6m</span><span class="s2">[</span><span class="s4">'ds'</span><span class="s2">].</span><span class="s0">dt</span><span class="s2">.</span><span class="s0">date</span>
    <span class="s0">forecast_period </span><span class="s2">= </span><span class="s0">forecast_6m</span><span class="s2">[</span><span class="s0">forecast_6m</span><span class="s2">[</span><span class="s4">'ds'</span><span class="s2">] &gt; </span><span class="s0">daily_sales</span><span class="s2">[</span><span class="s4">'ds'</span><span class="s2">].</span><span class="s0">max</span><span class="s2">()]</span>

    <span class="s0">sum_6m </span><span class="s2">= </span><span class="s0">forecast_period</span><span class="s2">[</span><span class="s4">'yhat'</span><span class="s2">].</span><span class="s0">sum</span><span class="s2">()</span>
    <span class="s0">avg_6m </span><span class="s2">= </span><span class="s0">forecast_period</span><span class="s2">[</span><span class="s4">'yhat'</span><span class="s2">].</span><span class="s0">mean</span><span class="s2">()</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">f&quot;Estimated total sales (next 6 months): </span><span class="s1">{</span><span class="s0">sum_6m</span><span class="s1">:</span><span class="s4">,.2f</span><span class="s1">}</span><span class="s4">&quot;</span><span class="s2">)</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">f&quot;Estimated average daily sales (next 6 months): </span><span class="s1">{</span><span class="s0">avg_6m</span><span class="s1">:</span><span class="s4">,.2f</span><span class="s1">}</span><span class="s4">&quot;</span><span class="s2">)</span>

    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;</span><span class="s1">\n</span><span class="s4">--- Prophet forecasting completed successfully. ---</span><span class="s1">\n</span><span class="s4">&quot;</span><span class="s2">)</span>

    <span class="s3">############################################################</span>
    <span class="s3"># 13. EK GÖRSELLESTIRMELER ve INSIGHTS</span>
    <span class="s3">############################################################</span>
    <span class="s0">cluster_counts </span><span class="s2">= </span><span class="s0">rfm</span><span class="s2">[</span><span class="s4">'Cluster'</span><span class="s2">].</span><span class="s0">value_counts</span><span class="s2">()</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">figure</span><span class="s2">(</span><span class="s0">figsize</span><span class="s2">=(</span><span class="s5">6</span><span class="s2">, </span><span class="s5">6</span><span class="s2">))</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">pie</span><span class="s2">(</span><span class="s0">cluster_counts</span><span class="s2">, </span><span class="s0">labels</span><span class="s2">=</span><span class="s0">cluster_counts</span><span class="s2">.</span><span class="s0">index</span><span class="s2">, </span><span class="s0">autopct</span><span class="s2">=</span><span class="s4">'%1.1f%%'</span><span class="s2">, </span><span class="s0">startangle</span><span class="s2">=</span><span class="s5">90</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">title</span><span class="s2">(</span><span class="s4">&quot;Cluster Distribution (k=5)&quot;</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">show</span><span class="s2">()</span>

    <span class="s0">metrics_to_plot </span><span class="s2">= [</span><span class="s4">'Frequency'</span><span class="s2">, </span><span class="s4">'CLV'</span><span class="s2">, </span><span class="s4">'AvgOrderValue'</span><span class="s2">, </span><span class="s4">'ReturnRate'</span><span class="s2">, </span><span class="s4">'LoyaltyScore'</span><span class="s2">]</span>
    <span class="s0">cluster_means </span><span class="s2">= </span><span class="s0">rfm</span><span class="s2">.</span><span class="s0">groupby</span><span class="s2">(</span><span class="s4">'Cluster'</span><span class="s2">)[</span><span class="s0">metrics_to_plot</span><span class="s2">].</span><span class="s0">mean</span><span class="s2">()</span>
    <span class="s0">cluster_means</span><span class="s2">.</span><span class="s0">plot</span><span class="s2">(</span><span class="s0">kind</span><span class="s2">=</span><span class="s4">'bar'</span><span class="s2">, </span><span class="s0">figsize</span><span class="s2">=(</span><span class="s5">12</span><span class="s2">, </span><span class="s5">6</span><span class="s2">))</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">title</span><span class="s2">(</span><span class="s4">&quot;Cluster Means of Key Metrics (k=5)&quot;</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">xlabel</span><span class="s2">(</span><span class="s4">&quot;Cluster&quot;</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">ylabel</span><span class="s2">(</span><span class="s4">&quot;Value&quot;</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">grid</span><span class="s2">()</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">legend</span><span class="s2">()</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">show</span><span class="s2">()</span>

    <span class="s0">season_clv </span><span class="s2">= </span><span class="s0">rfm</span><span class="s2">.</span><span class="s0">groupby</span><span class="s2">(</span><span class="s4">'Season'</span><span class="s2">)[</span><span class="s4">'CLV'</span><span class="s2">].</span><span class="s0">mean</span><span class="s2">().</span><span class="s0">sort_values</span><span class="s2">(</span><span class="s0">ascending</span><span class="s2">=</span><span class="s1">False</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">figure</span><span class="s2">(</span><span class="s0">figsize</span><span class="s2">=(</span><span class="s5">8</span><span class="s2">, </span><span class="s5">5</span><span class="s2">))</span>
    <span class="s0">sns</span><span class="s2">.</span><span class="s0">barplot</span><span class="s2">(</span><span class="s0">x</span><span class="s2">=</span><span class="s0">season_clv</span><span class="s2">.</span><span class="s0">index</span><span class="s2">, </span><span class="s0">y</span><span class="s2">=</span><span class="s0">season_clv</span><span class="s2">.</span><span class="s0">values</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">title</span><span class="s2">(</span><span class="s4">&quot;Seasonal Trends: Avg CLV per Season&quot;</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">xlabel</span><span class="s2">(</span><span class="s4">&quot;Season&quot;</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">ylabel</span><span class="s2">(</span><span class="s4">&quot;Avg CLV&quot;</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">grid</span><span class="s2">()</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">show</span><span class="s2">()</span>

    <span class="s0">df_merged2 </span><span class="s2">= </span><span class="s0">df</span><span class="s2">.</span><span class="s0">merge</span><span class="s2">(</span><span class="s0">rfm</span><span class="s2">[[</span><span class="s4">'CustomerID'</span><span class="s2">, </span><span class="s4">'Cluster'</span><span class="s2">]], </span><span class="s0">on</span><span class="s2">=</span><span class="s4">'CustomerID'</span><span class="s2">, </span><span class="s0">how</span><span class="s2">=</span><span class="s4">'left'</span><span class="s2">)</span>
    <span class="s0">product_info_2 </span><span class="s2">= </span><span class="s0">pd</span><span class="s2">.</span><span class="s0">read_csv</span><span class="s2">(</span><span class="s4">&quot;product_metadata.csv&quot;</span><span class="s2">)</span>
    <span class="s0">df_full </span><span class="s2">= </span><span class="s0">df_merged2</span><span class="s2">.</span><span class="s0">merge</span><span class="s2">(</span><span class="s0">product_info_2</span><span class="s2">[[</span><span class="s4">'ProductID'</span><span class="s2">, </span><span class="s4">'Category'</span><span class="s2">, </span><span class="s4">'Brand'</span><span class="s2">]],</span>
                               <span class="s0">left_on</span><span class="s2">=</span><span class="s4">'StockCode'</span><span class="s2">, </span><span class="s0">right_on</span><span class="s2">=</span><span class="s4">'ProductID'</span><span class="s2">, </span><span class="s0">how</span><span class="s2">=</span><span class="s4">'left'</span><span class="s2">)</span>
    <span class="s0">cluster_category_sales </span><span class="s2">= </span><span class="s0">df_full</span><span class="s2">.</span><span class="s0">groupby</span><span class="s2">([</span><span class="s4">'Cluster'</span><span class="s2">, </span><span class="s4">'Category'</span><span class="s2">])[</span><span class="s4">'TotalPrice'</span><span class="s2">].</span><span class="s0">sum</span><span class="s2">().</span><span class="s0">unstack</span><span class="s2">().</span><span class="s0">fillna</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>

    <span class="s0">plt</span><span class="s2">.</span><span class="s0">figure</span><span class="s2">(</span><span class="s0">figsize</span><span class="s2">=(</span><span class="s5">12</span><span class="s2">, </span><span class="s5">8</span><span class="s2">))</span>
    <span class="s0">sns</span><span class="s2">.</span><span class="s0">heatmap</span><span class="s2">(</span><span class="s0">cluster_category_sales</span><span class="s2">, </span><span class="s0">cmap</span><span class="s2">=</span><span class="s4">&quot;viridis&quot;</span><span class="s2">, </span><span class="s0">annot</span><span class="s2">=</span><span class="s1">False</span><span class="s2">, </span><span class="s0">cbar</span><span class="s2">=</span><span class="s1">True</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">title</span><span class="s2">(</span><span class="s4">&quot;Cluster vs Category Sales (k=5)&quot;</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">xlabel</span><span class="s2">(</span><span class="s4">&quot;Category&quot;</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">ylabel</span><span class="s2">(</span><span class="s4">&quot;Cluster&quot;</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">xticks</span><span class="s2">(</span><span class="s0">rotation</span><span class="s2">=</span><span class="s5">45</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">show</span><span class="s2">()</span>

    <span class="s3"># Pazarlama stratejileri küme bazında</span>
    <span class="s0">cluster_summary </span><span class="s2">= </span><span class="s0">cluster_summary</span><span class="s2">.</span><span class="s0">sort_values</span><span class="s2">(</span><span class="s0">by</span><span class="s2">=</span><span class="s4">'Cluster'</span><span class="s2">)</span>
    <span class="s1">for </span><span class="s0">cluster_id </span><span class="s1">in </span><span class="s0">cluster_summary</span><span class="s2">[</span><span class="s4">'Cluster'</span><span class="s2">]:</span>
        <span class="s0">c_data </span><span class="s2">= </span><span class="s0">cluster_summary</span><span class="s2">[</span><span class="s0">cluster_summary</span><span class="s2">[</span><span class="s4">'Cluster'</span><span class="s2">] == </span><span class="s0">cluster_id</span><span class="s2">]</span>
        <span class="s0">avg_clv </span><span class="s2">= </span><span class="s0">c_data</span><span class="s2">[</span><span class="s4">'CLV'</span><span class="s2">].</span><span class="s0">values</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s0">avg_freq </span><span class="s2">= </span><span class="s0">c_data</span><span class="s2">[</span><span class="s4">'Frequency'</span><span class="s2">].</span><span class="s0">values</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s0">avg_ret </span><span class="s2">= </span><span class="s0">c_data</span><span class="s2">[</span><span class="s4">'ReturnRate'</span><span class="s2">].</span><span class="s0">values</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>

        <span class="s0">print</span><span class="s2">(</span><span class="s4">f&quot;Cluster </span><span class="s1">{</span><span class="s0">cluster_id</span><span class="s1">}</span><span class="s4">:&quot;</span><span class="s2">)</span>
        <span class="s1">if </span><span class="s0">avg_clv </span><span class="s2">&gt; </span><span class="s5">1500 </span><span class="s1">and </span><span class="s0">avg_freq </span><span class="s2">&gt; </span><span class="s5">15 </span><span class="s1">and </span><span class="s0">avg_ret </span><span class="s2">&lt; </span><span class="s5">0.1</span><span class="s2">:</span>
            <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot; - Çok Premium müşteriler:&quot;</span><span class="s2">)</span>
            <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;   Öneriler: Özel hizmetler, ayrıcalıklı ürün erişimi, VIP etkinlik davetleri.&quot;</span><span class="s2">)</span>
        <span class="s1">elif </span><span class="s0">avg_clv </span><span class="s2">&gt; </span><span class="s5">1000 </span><span class="s1">and </span><span class="s0">avg_freq </span><span class="s2">&gt; </span><span class="s5">10 </span><span class="s1">and </span><span class="s0">avg_ret </span><span class="s2">&lt; </span><span class="s5">0.1</span><span class="s2">:</span>
            <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot; - Premium müşteriler:&quot;</span><span class="s2">)</span>
            <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;   Öneriler: VIP indirimler, kişiselleştirilmiş e-postalar, özel ürün lansmanları.&quot;</span><span class="s2">)</span>
        <span class="s1">elif </span><span class="s0">avg_ret </span><span class="s2">&gt; </span><span class="s5">0.2</span><span class="s2">:</span>
            <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot; - İade Oranı Yüksek:&quot;</span><span class="s2">)</span>
            <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;   Öneriler: İade politikasını iyileştirme, müşteri anketleri, ürün açıklamalarını geliştirme.&quot;</span><span class="s2">)</span>
        <span class="s1">elif </span><span class="s0">avg_clv </span><span class="s2">&gt; </span><span class="s5">500 </span><span class="s1">and </span><span class="s0">avg_freq </span><span class="s2">&gt; </span><span class="s5">5</span><span class="s2">:</span>
            <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot; - Orta-Uzun Vadeli Sadık Müşteriler:&quot;</span><span class="s2">)</span>
            <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;   Öneriler: Dönemsel kampanyalar, hatırlatma mailleri, teşvik kuponları.&quot;</span><span class="s2">)</span>
        <span class="s1">else</span><span class="s2">:</span>
            <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot; - Yeni/Düşük Değer Müşteriler:&quot;</span><span class="s2">)</span>
            <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;   Öneriler: Cross-sell ve up-sell fırsatları, giriş seviyesi promosyonlar.&quot;</span><span class="s2">)</span>
        <span class="s0">print</span><span class="s2">()</span>


    <span class="s3">############################################################</span>
    <span class="s3"># 14. TEST FUNCTION</span>
    <span class="s3">############################################################</span>
    <span class="s1">def </span><span class="s0">test_system</span><span class="s2">(</span><span class="s0">rfm_data</span><span class="s2">, </span><span class="s0">user_item_mat</span><span class="s2">, </span><span class="s0">cust_sim_df</span><span class="s2">):</span>
        <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;</span><span class="s1">\n</span><span class="s4">Testing Segmentation and Recommendation System...&quot;</span><span class="s2">)</span>
        <span class="s1">assert </span><span class="s4">'Cluster' </span><span class="s1">in </span><span class="s0">rfm_data</span><span class="s2">.</span><span class="s0">columns</span><span class="s2">, </span><span class="s4">&quot;Segmentation failed: 'Cluster' column missing.&quot;</span>
        <span class="s1">assert not </span><span class="s0">rfm_data</span><span class="s2">[</span><span class="s4">'Cluster'</span><span class="s2">].</span><span class="s0">isnull</span><span class="s2">().</span><span class="s0">any</span><span class="s2">(), </span><span class="s4">&quot;Segmentation failed: Null clusters found.&quot;</span>
        <span class="s0">test_customer_id </span><span class="s2">= </span><span class="s0">user_item_mat</span><span class="s2">.</span><span class="s0">index</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s0">test_recs </span><span class="s2">= </span><span class="s0">recommend_products</span><span class="s2">(</span><span class="s0">test_customer_id</span><span class="s2">, </span><span class="s0">user_item_mat</span><span class="s2">, </span><span class="s0">cust_sim_df</span><span class="s2">)</span>
        <span class="s1">assert </span><span class="s0">len</span><span class="s2">(</span><span class="s0">test_recs</span><span class="s2">) &gt; </span><span class="s5">0</span><span class="s2">, </span><span class="s4">&quot;Recommendation system failed: No products recommended.&quot;</span>
        <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;All tests passed successfully!&quot;</span><span class="s2">)</span>


    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;</span><span class="s1">\n</span><span class="s4">Running system tests...&quot;</span><span class="s2">)</span>
    <span class="s0">test_system</span><span class="s2">(</span><span class="s0">rfm</span><span class="s2">, </span><span class="s0">user_item_matrix</span><span class="s2">, </span><span class="s0">customer_similarity_df</span><span class="s2">)</span>
    <span class="s0">print</span><span class="s2">(</span><span class="s4">&quot;</span><span class="s1">\n</span><span class="s4">Code executed and improved successfully with k=5 and reduced collinearity!&quot;</span><span class="s2">)</span>

</pre>
</body>
</html>